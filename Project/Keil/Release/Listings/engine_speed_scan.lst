C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 08/02/2025 16:49:15 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE ENGINE_SPEED_SCAN
OBJECT MODULE PLACED IN .\Release\Objects\engine_speed_scan.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\engine_speed_scan.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVE
                    -CTOR(0X000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRI
                    -NT(.\Release\Listings\engine_speed_scan.lst) OBJECT(.\Release\Objects\engine_speed_scan.obj)

line level    source

   1          #include "engine_speed_scan.h"
   2          
   3          #if ENGINE_SPEED_SCAN_ENABLE
   4          
   5          #if 0
              // å‘åŠ¨æœºæ¯è½¬ä¸€åœˆï¼Œèƒ½æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•°
              #ifndef ENGINE_SPEED_SCAN_PULSE_PER_TURN
              #define ENGINE_SPEED_SCAN_PULSE_PER_TURN (16)
              #endif
              
              volatile u16 engine_scan_time_cnt = 0;        // å‘åŠ¨æœºè½¬é€Ÿæ‰«ææ—¶ï¼Œç”¨åˆ°çš„æ—¶é—´è®¡æ•°å€¼ï¼Œä¼š
             -åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­ç´¯åŠ 
              volatile u16 engine_actual_scan_time_cnt = 0; // å­˜æ”¾å®é™…çš„å‘åŠ¨æœºè½¬é€Ÿæ‰«æç”¨æ—¶
              
              // æ ‡å¿—ä½ï¼Œæ˜¯å¦æœ‰æ›´æ–°è„‰å†²è®¡æ•°,ç”±å®šæ—¶å™¨æ¥ç½®ä½
              // 0--æœªæ›´æ–°è„‰å†²è®¡æ•°ï¼Œ1--æœ‰æ–°çš„è„‰å†²è®¡æ•°
              volatile bit flag_is_update_engine_pulse_cnt = 0;
              /*
                  å­˜æ”¾ æ£€æµ‹åˆ°çš„å‘é€æœºè½¬é€Ÿçš„è„‰å†²è®¡æ•°å€¼ï¼Œä¼šåœ¨ä¸­æ–­å†…ç´¯åŠ 
                  ä½¿ç”¨äº†åŒç¼“å†²ï¼Œ[0]ç”¨åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­ï¼Œ[1]ç”¨åœ¨å‘åŠ¨æœºè½¬é€Ÿå¤„ç†å‡½æ•°ä¸­
                  å½“ flag_is_update_engine_pulse_cnt == 1æ—¶ï¼Œè¯´æ˜å·²ç»æœ‰æ•°æ®æ›´æ–°
              */
              volatile u32 detect_engine_pulse_cnt[2] = {0};
              #endif
  24          
  25          // å‘åŠ¨æœºè½¬é€Ÿçš„ç›¸å…³é…ç½®
  26          void engine_speed_scan_config(void)
  27          {
  28   1      #if 1 // ä½¿ç”¨å®šæ—¶å™¨æ‰«æIOç”µå¹³çš„æ–¹å¼
  29   1      
  30   1          P0_MD0 &= ~GPIO_P02_MODE_SEL(0x3); // è¾“å…¥æ¨¡å¼
  31   1          P0_PU |= GPIO_P02_PULL_UP(0x01);   // ä¸Šæ‹‰
  32   1      
  33   1      #endif // ä½¿ç”¨å®šæ—¶å™¨æ‰«æIOç”µå¹³çš„æ–¹å¼
  34   1      }
  35          
  36          #if 0                                   // ä½¿ç”¨å®šæ—¶å™¨æ‰«æè„‰å†²çš„æ–¹å¼ï¼Œå½“ä¸€è½®æ‰«æå‘¨æœŸç»“
             -æŸæ‰æ›´æ–°
              // å‘åŠ¨æœºè½¬é€Ÿæ‰«æ
              void engine_speed_scan(void)
              {
              #define CONVER_ONE_MINUTE_TO_MS (60000) // å°†1minè½¬æ¢æˆä»¥msä¸ºå•ä½çš„æ•°æ®
                  volatile u32 rpm = 0;
                  static volatile u8 engine_speed_scan_cnt = 0; // é‡å¤æ‰«æçš„æ£€æµ‹æ¬¡æ•°(ç”¨äºæ»¤æ³¢)
                  static volatile u32 cur_rpm_average = 0;      // å­˜æ”¾å‘åŠ¨æœºè½¬é€Ÿçš„å¹³å‡å€¼
              
                  if (flag_is_update_engine_pulse_cnt)
                  {
                      // å¦‚æœæœ‰æ•°æ®æ›´æ–°
                      flag_is_update_engine_pulse_cnt = 0; // æ¸…é™¤æ ‡å¿—ä½
              
                      /*
                          (1min / 1minè½¬è¿‡çš„åœˆæ•°) == (æ‰«ææ—¶é—´ / æ‰«ææ—¶é—´å†…çš„è½¬è¿‡çš„åœˆæ•°)
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 08/02/2025 16:49:15 PAGE 2   

                          1minè½¬è¿‡çš„åœˆæ•° == 1min * æ‰«ææ—¶é—´å†…è½¬è¿‡çš„åœˆæ•° / æ‰«ææ—¶é—´
                          1minè½¬è¿‡çš„åœˆæ•° == 1min * (æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° / å‘åŠ¨æœºè½¬è¿‡ä¸€åœˆ
             -å¯¹åº”çš„è„‰å†²ä¸ªæ•°) / æ‰«ææ—¶é—´
                          è½¬æ¢æˆå•ç‰‡æœºèƒ½è®¡ç®—çš„å½¢å¼ï¼š
                          1minè½¬è¿‡çš„åœˆæ•° == æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° * 1min / å‘åŠ¨æœºè½¬è¿‡ä¸€åœˆå
             -¯¹åº”çš„è„‰å†²ä¸ªæ•° / æ‰«ææ—¶é—´
                          1minè½¬è¿‡çš„åœˆæ•° == æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° * 1min / æ‰«ææ—¶é—´ / å‘åŠ¨æ
             -œºè½¬è¿‡ä¸€åœˆå¯¹åº”çš„è„‰å†²ä¸ªæ•°
                      */
              
              #if USE_MY_DEBUG
              
                      // if (detect_engine_pulse_cnt[1])
                      // {
                      //     printf("pulse_cnt %lu \n", detect_engine_pulse_cnt[1]);
                      //     printf("engine actual scan time %u\n",engine_actual_scan_time_cnt);
                      // }
              
              #endif // #if USE_MY_DEBUG
              
                      rpm = detect_engine_pulse_cnt[1] * (CONVER_ONE_MINUTE_TO_MS / ENGINE_SPEED_SCAN_PULSE_PER_TURN) / 
             -engine_actual_scan_time_cnt;
                      if (engine_speed_scan_cnt < ENGINE_SPEED_SCAN_FILTER_CNT)
                      {
                          // å¦‚æœæœªè¾¾åˆ°é‡å¤æ‰«æçš„æ£€æµ‹æ¬¡æ•°
                          engine_speed_scan_cnt++;
                          cur_rpm_average += rpm;
              
                          // if (rpm)
                          // {
                          //     printf("ori rpm %lu\n", rpm);
                          // }
                      }
                      else
                      {
                          // å¦‚æœè¾¾åˆ°çš„é‡å¤æ‰«æçš„æ£€æµ‹æ¬¡æ•°
                          cur_rpm_average /= ENGINE_SPEED_SCAN_FILTER_CNT;
              
                          engine_speed_scan_cnt = 0; // æ¸…é™¤æ‰«ææ¬¡æ•°çš„è®¡æ•°å€¼
              
                          // é™åˆ¶å¾…å‘é€çš„å‘åŠ¨æœºè½¬é€Ÿ
                          if (cur_rpm_average >= 65535)
                          {
                              cur_rpm_average = 65535;
                          }
              
                          // if (cur_rpm_average != 0)
                          // {
                          //     printf("engine speed %lu rpm\n", cur_rpm_average);
                          // }
              
              #if 0
              
                          if (cur_rpm_average != 0)
                          {
                              printf("engine speed %lu rpm\n", cur_rpm_average);
                          }
              
              #endif // #if 0
              
                          fun_info.engine_speeed = cur_rpm_average; // å‘å…¨å±€å˜é‡å­˜æ”¾å‘åŠ¨æœºè½¬é€Ÿ
                          cur_rpm_average = 0;
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 08/02/2025 16:49:15 PAGE 3   

              
                          flag_get_engine_speed = 1; // å‘é€å‘åŠ¨æœºè½¬é€Ÿ
                      }
                  }
              }// ä½¿ç”¨å®šæ—¶å™¨æ‰«æè„‰å†²çš„æ–¹å¼ï¼Œå½“ä¸€è½®æ‰«æå‘¨æœŸç»“æŸæ‰æ›´æ–°
              
              #endif
 117          
 118          static volatile u32 engine_speed_buff[ENGINE_SPEED_SCAN_BUFF_SIZE] = {0};
 119          static volatile u8 cur_send_engine_speed_buff_index = 0; // å½“å‰è¦å‘é€çš„ç¼“å†²åŒºç´¢å¼•
 120          volatile bit flag_is_send_engine_speed_time_come = 0;    // æ ‡å¿—ä½ï¼Œå‘é€å‘åŠ¨æœºè½¬é€Ÿçš„æ—¶é—´åˆ°æ
             -¥
 121          
 122          volatile u32 engine_speed_scan_cnt = 0; // æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•°ï¼Œåœ¨å®šæ—¶å™¨ä¸­æ–­ç´¯åŠ 
 123          volatile u32 engine_speed_scan_ms = 0;  // åœ¨å®šæ—¶å™¨ä¸­æ–­ç´¯åŠ 
 124          
 125          static volatile u32 cur_engine_speed_scan_cnt = 0;
 126          static volatile u32 cur_engine_speed_scan_ms = 0;
 127          
 128          volatile bit flag_is_engine_speed_scan_over_time = 0; // æ ‡å¿—ä½ï¼Œæ£€æµ‹æ˜¯å¦è¶…æ—¶
 129          
 130          void update_engine_speed_scan_data(void) // æ›´æ–°æ£€æµ‹å‘åŠ¨æœºè½¬é€Ÿçš„æ•°æ®
 131          {
 132   1          cur_engine_speed_scan_cnt += engine_speed_scan_cnt;
 133   1          engine_speed_scan_cnt = 0;
 134   1          cur_engine_speed_scan_ms += engine_speed_scan_ms;
 135   1          engine_speed_scan_ms = 0;
 136   1      }
 137          
 138          // å‘åŠ¨æœºè½¬é€Ÿæ‰«æ
 139          void engine_speed_scan(void)
 140          {
 141   1      #define CONVER_ONE_MINUTE_TO_MS (60000UL) // å°†1minè½¬æ¢æˆä»¥msä¸ºå•ä½çš„æ•°æ®
 142   1          volatile u32 rpm = 0;
 143   1      
 144   1          if (cur_engine_speed_scan_ms >= ENGINE_SPEED_SCAN_UPDATE_TIME || flag_is_engine_speed_scan_over_time)
 145   1          // if (cur_engine_speed_scan_ms >= ENGINE_SPEED_SCAN_UPDATE_TIME )
 146   1          {
 147   2              // printf("cur_engine_speed_scan_ms:%lu\n", cur_engine_speed_scan_ms);
 148   2              if (flag_is_engine_speed_scan_over_time)
 149   2              {
 150   3                  rpm = 0;
 151   3              }
 152   2              else
 153   2              {
 154   3                  /*
 155   3                      (1min / 1minè½¬è¿‡çš„åœˆæ•°) == (æ‰«ææ—¶é—´ / æ‰«ææ—¶é—´å†…çš„è½¬è¿‡çš„åœˆæ•°)
 156   3                      1minè½¬è¿‡çš„åœˆæ•° == 1min * æ‰«ææ—¶é—´å†…è½¬è¿‡çš„åœˆæ•° / æ‰«ææ—¶é—´
 157   3                      1minè½¬è¿‡çš„åœˆæ•° == 1min * (æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° / å‘åŠ¨æœºè½¬è¿‡ä¸
             -€åœˆå¯¹åº”çš„è„‰å†²ä¸ªæ•°) / æ‰«ææ—¶é—´
 158   3                      è½¬æ¢æˆå•ç‰‡æœºèƒ½è®¡ç®—çš„å½¢å¼ï¼š
 159   3                      1minè½¬è¿‡çš„åœˆæ•° == æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° * 1min / å‘åŠ¨æœºè½¬è¿‡ä¸€
             -åœˆå¯¹åº”çš„è„‰å†²ä¸ªæ•° / æ‰«ææ—¶é—´
 160   3                      1minè½¬è¿‡çš„åœˆæ•° == æ‰«ææ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° * 1min / æ‰«ææ—¶é—´ / å‘
             -åŠ¨æœºè½¬è¿‡ä¸€åœˆå¯¹åº”çš„è„‰å†²ä¸ªæ•°
 161   3                  */
 162   3                  // rpm = (u32)cur_engine_speed_scan_cnt * ((u32)CONVER_ONE_MINUTE_TO_MS / ENGINE_SPEED_SCAN_PU
             -LSE_PER_TURN) / cur_engine_speed_scan_ms;
 163   3      
 164   3                  /*
 165   3                      æ‰«ææ—¶é—´å†…è½¬è¿‡çš„åœˆæ•° == ä¸€ä¸ªè„‰å†²å¯¹åº”è½¬è¿‡çš„åœˆæ•° *ã€€æ‰«ææ—¶é—´å†…é‡‡
             -é›†åˆ°çš„è„‰å†²ä¸ªæ•°
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 08/02/2025 16:49:15 PAGE 4   

 166   3                      1minè½¬è¿‡çš„åœˆæ•°ã€€== æ‰«ææ—¶é—´å†…è½¬è¿‡çš„åœˆæ•° / æ‰«ææ—¶é—´ * 1min
 167   3                  */
 168   3                  rpm = (u32)cur_engine_speed_scan_cnt * ENGINE_SPEED_SCAN_A_PULSE_PER_TURNS * CONVER_ONE_MINUTE
             -_TO_MS / cur_engine_speed_scan_ms;
 169   3              }
 170   2      
 171   2              // printf("cur engine speed pulse cnt:%lu\n",cur_engine_speed_scan_cnt);
 172   2      
 173   2              cur_engine_speed_scan_cnt = 0;
 174   2              cur_engine_speed_scan_ms = 0;
 175   2              flag_is_engine_speed_scan_over_time = 0;
 176   2      
 177   2              // é™åˆ¶å¾…å‘é€çš„å‘åŠ¨æœºè½¬é€Ÿ
 178   2              if (rpm >= 65535)
 179   2              {
 180   3                  rpm = 65535;
 181   3              }
 182   2      
 183   2      #if 0 
                      /*
                          æ‰«æå®Œå°±å‘é€çš„ç¨‹åºï¼Œåœ¨æ˜¾ç¤ºéƒ¨åˆ†ä¼šæœ‰å¡é¡¿ï¼Œ
                          æ˜¾ç¤ºåšä¸äº†åŠ¨ç”»ï¼Œåªèƒ½å•ç‰‡æœºæ¥è°ƒèŠ‚
                      */
              
                      // printf("cur rpm %lu\n", rpm);
              
                      fun_info.engine_speeed = rpm; // å‘å…¨å±€å˜é‡å­˜æ”¾å‘åŠ¨æœºè½¬é€Ÿ
                      flag_get_engine_speed = 1;    // å‘é€å‘åŠ¨æœºè½¬é€Ÿ
              #endif
 194   2      
 195   2              engine_speed_buff_update(rpm);
 196   2          }
 197   1      }
 198          
 199          void engine_speed_buff_update(u32 engine_speed)
 200          {
 201   1          static u32 last_engine_speed = 0;   // å­˜æ”¾ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„å‘åŠ¨æœºè½¬é€Ÿ
 202   1          u32 engine_speed_difference = 0;    // å­˜æ”¾ å‘åŠ¨æœºè½¬é€Ÿ çš„å·®å€¼
 203   1          bit dir_of_engine_speed_change = 0; // å‘åŠ¨æœºè½¬é€Ÿå˜åŒ–çš„æ–¹å‘ï¼Œ0--å˜å°ï¼Œ1--å˜å¤§
 204   1          u8 i = 0;                           // å¾ªç¯è®¡æ•°å€¼
 205   1      
 206   1          if (engine_speed > last_engine_speed)
 207   1          {
 208   2              // å¦‚æœå½“å‰çš„å‘åŠ¨æœºè½¬é€Ÿ å¤§äº ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„å‘åŠ¨æœºè½¬é€Ÿ
 209   2              engine_speed_difference = engine_speed - last_engine_speed;
 210   2              dir_of_engine_speed_change = 1; // è¡¨ç¤ºå‘åŠ¨æœºè½¬é€Ÿå˜å¤§
 211   2          }
 212   1          else if (engine_speed < last_engine_speed)
 213   1          {
 214   2              // å¦‚æœå½“å‰çš„å‘åŠ¨æœºè½¬é€Ÿ å°äº ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„å‘åŠ¨æœºè½¬é€Ÿ
 215   2              engine_speed_difference = last_engine_speed - engine_speed;
 216   2              dir_of_engine_speed_change = 0; // è¡¨ç¤ºå‘åŠ¨æœºè½¬é€Ÿå˜å°
 217   2          }
 218   1          else
 219   1          {
 220   2              for (i = 0; i < ENGINE_SPEED_SCAN_BUFF_SIZE; i++)
 221   2              {
 222   3                  engine_speed_buff[i] = engine_speed;
 223   3              }
 224   2      
 225   2              // // æ²¡æœ‰å·®å€¼ï¼Œç›´æ¥æ›´æ–°ï¼ˆä¿®å¤æ²¡æœ‰å·®å€¼ä¸”æ•°å€¼ä¸º0æ—¶ï¼Œæ²¡æœ‰å‘é€æ•°æ®çš„é—®é
             -¢˜ï¼‰
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 08/02/2025 16:49:15 PAGE 5   

 226   2              // fun_info.engine_speeed = engine_speed;
 227   2              // flag_get_engine_speed = 1;
 228   2      
 229   2              cur_send_engine_speed_buff_index = 0; // æ¸¸æ ‡å¤ä½
 230   2              return;
 231   2          }
 232   1      
 233   1          if (dir_of_engine_speed_change)
 234   1          {
 235   2              // å¦‚æœå‘åŠ¨æœºè½¬é€Ÿåœ¨å˜å¤§ï¼Œæ•°ç»„ä» [0] ~ [ENGINE_SPEED_SCAN_BUFF_SIZE - 1] æ•°å€¼è¶Šæ¥
             -è¶Šå¤§
 236   2              for (i = 0; i < ENGINE_SPEED_SCAN_BUFF_SIZE; i++)
 237   2              {
 238   3                  engine_speed_buff[i] = engine_speed_difference * (i + 1) / ENGINE_SPEED_SCAN_BUFF_SIZE + last_
             -engine_speed;
 239   3              }
 240   2          }
 241   1          else
 242   1          {
 243   2              // å¦‚æœå‘åŠ¨æœºè½¬é€Ÿåœ¨å˜å°ï¼Œæ•°ç»„ä» [0] ~ [ENGINE_SPEED_SCAN_BUFF_SIZE - 1] æ•°å€¼è¶Šæ¥
             -è¶Šå°
 244   2              for (i = 0; i < ENGINE_SPEED_SCAN_BUFF_SIZE; i++)
 245   2              {
 246   3                  // è¿™ä¸€å¥ä¼šå¯¼è‡´æœ€åä¸èƒ½æ˜¾ç¤º æ•°å€¼ä¸º0 ï¼š
 247   3                  // engine_speed_buff[ENGINE_SPEED_SCAN_BUFF_SIZE - 1 - i] = last_engine_speed - (u32)engine_sp
             -eed_difference * (ENGINE_SPEED_SCAN_BUFF_SIZE - i - 1) / ENGINE_SPEED_SCAN_BUFF_SIZE;
 248   3      
 249   3                  engine_speed_buff[ENGINE_SPEED_SCAN_BUFF_SIZE - 1 - i] = last_engine_speed - (u32)engine_speed
             -_difference * (ENGINE_SPEED_SCAN_BUFF_SIZE - i - 1) / ENGINE_SPEED_SCAN_BUFF_SIZE;
 250   3              }
 251   2          }
 252   1      
 253   1          last_engine_speed = engine_speed;
 254   1          cur_send_engine_speed_buff_index = 0; // æ¸¸æ ‡å¤ä½
 255   1      }
 256          
 257          void engine_speed_send_data(void)
 258          {
 259   1          if (flag_is_send_engine_speed_time_come) // å¦‚æœå‘é€ å‘åŠ¨æœºè½¬é€Ÿçš„æ—¶é—´åˆ°æ¥
 260   1          {
 261   2              flag_is_send_engine_speed_time_come = 0;
 262   2      
 263   2              if (cur_send_engine_speed_buff_index >= ENGINE_SPEED_SCAN_BUFF_SIZE)
 264   2              {
 265   3                  // é˜²æ­¢è¶Šç•Œ
 266   3                  return;
 267   3              }
 268   2      
 269   2              fun_info.engine_speeed = engine_speed_buff[cur_send_engine_speed_buff_index];
 270   2              cur_send_engine_speed_buff_index++;
 271   2      
 272   2              // printf("fun_info.engine_speed = %lu\n", fun_info.engine_speeed);
 273   2              flag_get_engine_speed = 1;
 274   2          }
 275   1      }
 276          
 277          #endif // #if ENGINE_SPEED_SCAN_ENABLE


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    549    ----
   CONSTANT SIZE    =   ----    ----
C51 COMPILER V9.60.7.0   ENGINE_SPEED_SCAN                                                 08/02/2025 16:49:15 PAGE 6   

   XDATA SIZE       =     45      13
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
