C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE FUEL_CAPACITY
OBJECT MODULE PLACED IN .\Release\Objects\fuel_capacity.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\fuel_capacity.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR
                    -(0X000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.
                    -\Release\Listings\fuel_capacity.lst) OBJECT(.\Release\Objects\fuel_capacity.obj)

line level    source

   1          #include "fuel_capacity.h"
   2          
   3          volatile u32 fuel_capacity_scan_cnt = 0; // 扫描时间计数，在1ms定时器中断中累加
   4          // volatile u32 fuel_adc_val = 0;
   5          // volatile u32 fuel_adc_scan_cnt = 0; // 在更新时间到来前，记录adc扫描的次数
   6          
   7          // volatile u8 fuel_percent = 0xFF;
   8          
   9          // static volatile u8 last_fuel_percent = 0xFF; // 记录上一次检测到的油量百分比
  10          // 旧版到的油量检测程序：
  11          #if 0
              void fuel_capacity_scan(void)
              {
                  adc_sel_pin(ADC_PIN_FUEL); // 内部至少占用1ms
                  adc_val = adc_getval();
                  // printf("fuel adc %u \n", adc_val);
              
                  fuel_adc_val += adc_val;
                  fuel_adc_scan_cnt++;
              
                  // fuel_capacity_scan_cnt += ONE_CYCLE_TIME_MS;
                  if (fuel_capacity_scan_cnt >= FUEL_CAPACITY_SCAN_TIME_MS)
                  {
                      // 如果到了扫描更新时间，
                      // bit flag_is_update_percent = 1; // 是否更新百分比,0--不更新,1--更新
                      fuel_capacity_scan_cnt = 0;
                      fuel_adc_val /= fuel_adc_scan_cnt; // 求出扫描时间内得到的ad平均值
                      fuel_adc_scan_cnt = 0;
                      // printf("fuel adc val %lu \n", fuel_adc_val);
              
              #ifdef USE_MY_DEBUG
              #if USE_MY_DEBUG
                      // printf("fuel adc val %lu \n", fuel_adc_val);
              #endif // #if USE_MY_DEBUG
              #endif // #ifdef USE_MY_DEBUG
              
                      // 先确定油量百分比的大致范围：
                      if (fuel_adc_val < FUEL_MAX_ADC_VAL + (FUEL_90_PERCENT_ADC_VAL - FUEL_MAX_ADC_VAL) / 3)
                      {
                          fuel_percent = 100;
                      }
                      else if (fuel_adc_val < (FUEL_90_PERCENT_ADC_VAL - (FUEL_90_PERCENT_ADC_VAL - FUEL_MAX_ADC_VAL) / 
             -3))
                      {
                          fuel_percent = 90;
                      }
                      else if (fuel_adc_val < (FUEL_80_PERCENT_ADC_VAL - (FUEL_80_PERCENT_ADC_VAL - FUEL_90_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 80;
                      }
                      else if (fuel_adc_val < (FUEL_70_PERCENT_ADC_VAL - (FUEL_70_PERCENT_ADC_VAL - FUEL_80_PERCENT_ADC_
             -VAL) / 3))
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 2   

                      {
                          fuel_percent = 70;
                      }
                      else if (fuel_adc_val < (FUEL_60_PERCENT_ADC_VAL - (FUEL_60_PERCENT_ADC_VAL - FUEL_70_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 60;
                      }
                      else if (fuel_adc_val < (FUEL_50_PERCENT_ADC_VAL - (FUEL_50_PERCENT_ADC_VAL - FUEL_60_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 50;
                      }
                      else if (fuel_adc_val < (FUEL_40_PERCENT_ADC_VAL - (FUEL_40_PERCENT_ADC_VAL - FUEL_50_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 40;
                      }
                      else if (fuel_adc_val < (FUEL_30_PERCENT_ADC_VAL - (FUEL_30_PERCENT_ADC_VAL - FUEL_40_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 30;
                      }
                      else if (fuel_adc_val < (FUEL_20_PERCENT_ADC_VAL - (FUEL_20_PERCENT_ADC_VAL - FUEL_30_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 20;
                      }
                      else if (fuel_adc_val < (FUEL_10_PERCENT_ADC_VAL - (FUEL_10_PERCENT_ADC_VAL - FUEL_20_PERCENT_ADC_
             -VAL) / 3))
                      {
                          fuel_percent = 10;
                      }
                      else
                      {
                          fuel_percent = 0;
                      }
              
              #ifdef USE_MY_DEBUG
              #if USE_MY_DEBUG
                      // printf("fuel percent nearly %bu\n", fuel_percent);
              #endif // #if USE_MY_DEBUG
              #endif // #ifdef USE_MY_DEBUG
              
                      // 再根据死区限制油量百分比
                      if (fuel_adc_val > FUEL_MIN_ADC_VAL - ((FUEL_MIN_ADC_VAL - FUEL_10_PERCENT_ADC_VAL) / 3))
                      {
                          // 0%油量
                          fuel_percent = 0;
                      }
                      else if (fuel_adc_val < (FUEL_10_PERCENT_ADC_VAL + (FUEL_MIN_ADC_VAL - FUEL_10_PERCENT_ADC_VAL) / 
             -3) &&
                               fuel_adc_val > FUEL_10_PERCENT_ADC_VAL - (FUEL_10_PERCENT_ADC_VAL - FUEL_20_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 10%油量
                          fuel_percent = 10;
                      }
                      else if (fuel_adc_val < (FUEL_20_PERCENT_ADC_VAL + (FUEL_10_PERCENT_ADC_VAL - FUEL_20_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_20_PERCENT_ADC_VAL - (FUEL_20_PERCENT_ADC_VAL - FUEL_30_PERCENT_ADC_V
             -AL) / 3)
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 3   

                      {
                          // 20%油量
                          fuel_percent = 20;
                      }
                      else if (fuel_adc_val < (FUEL_30_PERCENT_ADC_VAL + (FUEL_20_PERCENT_ADC_VAL - FUEL_30_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_30_PERCENT_ADC_VAL - (FUEL_30_PERCENT_ADC_VAL - FUEL_40_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 30%油量
                          fuel_percent = 30;
                      }
                      else if (fuel_adc_val < (FUEL_40_PERCENT_ADC_VAL + (FUEL_30_PERCENT_ADC_VAL - FUEL_40_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_40_PERCENT_ADC_VAL - (FUEL_40_PERCENT_ADC_VAL - FUEL_50_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 40%油量
                          fuel_percent = 40;
                      }
                      else if (fuel_adc_val < (FUEL_50_PERCENT_ADC_VAL + (FUEL_40_PERCENT_ADC_VAL - FUEL_50_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_50_PERCENT_ADC_VAL - (FUEL_50_PERCENT_ADC_VAL - FUEL_60_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 50%油量
                          fuel_percent = 50;
                      }
              
                      else if (fuel_adc_val < (FUEL_60_PERCENT_ADC_VAL + (FUEL_50_PERCENT_ADC_VAL - FUEL_60_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_60_PERCENT_ADC_VAL - (FUEL_60_PERCENT_ADC_VAL - FUEL_70_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 60%油量
                          fuel_percent = 60;
                      }
                      else if (fuel_adc_val < (FUEL_70_PERCENT_ADC_VAL + (FUEL_60_PERCENT_ADC_VAL - FUEL_70_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_70_PERCENT_ADC_VAL - (FUEL_70_PERCENT_ADC_VAL - FUEL_80_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 70%油量
                          fuel_percent = 70;
                      }
                      else if (fuel_adc_val < (FUEL_80_PERCENT_ADC_VAL + (FUEL_70_PERCENT_ADC_VAL - FUEL_80_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_80_PERCENT_ADC_VAL - (FUEL_80_PERCENT_ADC_VAL - FUEL_90_PERCENT_ADC_V
             -AL) / 3)
                      {
                          // 80%油量
                          fuel_percent = 80;
                      }
                      else if (fuel_adc_val < (FUEL_90_PERCENT_ADC_VAL + (FUEL_80_PERCENT_ADC_VAL - FUEL_90_PERCENT_ADC_
             -VAL) / 3) &&
                               fuel_adc_val > FUEL_90_PERCENT_ADC_VAL - (FUEL_90_PERCENT_ADC_VAL - FUEL_MAX_ADC_VAL) / 3
             -)
                      {
                          // 90%油量
                          fuel_percent = 90;
                      }
                      else if (fuel_adc_val < (FUEL_MAX_ADC_VAL + ((FUEL_90_PERCENT_ADC_VAL - FUEL_MAX_ADC_VAL) / 3)))
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 4   

                      {
                          // 100%油量
                          fuel_percent = 100;
                      }
                      else
                      {
                          // 如果检测到的ad值不在死区范围内,不更新油量
                          // flag_is_update_percent = 0;
                      }
              
              
                      // printf("fuel percent %bu\n", fuel_percent);
              #ifdef USE_MY_DEBUG
              #if USE_MY_DEBUG
                      // printf("fuel percent %bu\n", fuel_percent);
              #endif // #if USE_MY_DEBUG
              #endif // #ifdef USE_MY_DEBUG
              
                      fun_info.fuel = fuel_percent;
                      fuel_adc_val = 0xFF;
                      flag_get_fuel = 1;
                  } // if (fuel_capacity_scan_cnt >= FUEL_CAPACITY_SCAN_TIME_MS)
              }
              #endif
 175          
 176          // 滑动平均：
 177          #define SAMPLE_COUNT 20 // 样本计数
 178          static volatile u16 samples[SAMPLE_COUNT] = {0};
 179          static volatile u8 sample_index = 0;
 180          u16 get_filtered_adc(u16 adc_val)
 181          {
 182   1          u8 i = 0;
 183   1          u32 sum = 0;
 184   1          samples[sample_index++] = adc_val;
 185   1          if (sample_index >= SAMPLE_COUNT)
 186   1              sample_index = 0;
 187   1      
 188   1          for (i = 0; i < SAMPLE_COUNT; i++)
 189   1              sum += samples[i];
 190   1      
 191   1          return sum / SAMPLE_COUNT;
 192   1      }
 193          
 194          // 给滑动平均使用到的数组进行初始化
 195          void samples_init(u16 adc_val)
 196          {
 197   1          u8 i = 0;
 198   1          for (; i < SAMPLE_COUNT; i++)
 199   1          {
 200   2              samples[i] = adc_val;
 201   2          }
 202   1      }
 203          
 204          // 将油量检测对应的ad值转换成百分比值
 205          u8 convert_fuel_adc_to_percent(u16 fuel_adc_val)
 206          {
 207   1      #if 0
                  u8 ret = 0;
              
                  // 如果超出了 最大油量的ad值和最小油量的ad值之间的范围 ，说明没有接油量
             -检测
                  if (fuel_adc_val >= (4095 - 500) ||
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 5   

                      fuel_adc_val <= (0 + 500))
                  {
                      ret = 0xFF; // 根据串口收发协议，0xFF对应没有接油量检测
                  }
                  else
                  {
                      if (fuel_adc_val > FUEL_MIN_ADC_VAL) // 如果检测到的ad值比最小油量对应的ad值还要
             -小
                      {
                          ret = 0; // 0% 油量
                      }
                      else if (fuel_adc_val < FUEL_MAX_ADC_VAL) // 如果检测到的油量比100%还要大一些
                      {
                          ret = 100;
                      }
                      else
                      {
                          // u16 tmp_val = (FUEL_MAX_ADC_VAL - FUEL_MIN_ADC_VAL) / 100; /* 将油量最大的ad值和油
             -量最小对应的ad值 划成100份 */
                          // ret = (fuel_adc_val - FUEL_MIN_ADC_VAL) / tmp_val;
              
                          u16 tmp_val = (FUEL_MIN_ADC_VAL - FUEL_MAX_ADC_VAL) / 100; /* 将油量最大的ad值和油量
             -最小对应的ad值 划成100份 */
                          ret = (fuel_adc_val - FUEL_MAX_ADC_VAL) / tmp_val;
                      }
                  }
              
                  return ret;
              #endif
 238   1      
 239   1      #if 1
 240   1          u8 ret = 0;
 241   1      
 242   1          // 如果超出了 最大油量的ad值和最小油量的ad值之间的范围 ，说明没有接油量
             -检测
 243   1          if (fuel_adc_val >= (4095 - 500) ||
 244   1              fuel_adc_val <= (0 + 500))
 245   1          {
 246   2              ret = 0xFF; // 根据串口收发协议，0xFF对应没有接油量检测
 247   2          }
 248   1          else
 249   1          {
 250   2              if (fuel_adc_val > FUEL_LEVEL_0_ADC_VAL) // 如果检测到的ad值比最小油量对应的ad值
             -要大
 251   2              {
 252   3                  ret = 0; // 0% 油量
 253   3              }
 254   2              else if (fuel_adc_val <= FUEL_LEVEL_6_ADC_VAL) // 如果检测到的油量比100%还要大一些
 255   2              {
 256   3                  ret = 100;
 257   3              }
 258   2              else if (fuel_adc_val <= FUEL_LEVEL_0_ADC_VAL && fuel_adc_val > FUEL_LEVEL_1_ADC_VAL) /* 0格油
             -到1格油量，0% ~ 18% */
 259   2              {
 260   3                  /*
 261   3                      用采集到的ad值减去当前挡位最小的ad值，再除以（当前挡位最大的ad
             -值-当前挡位最小的ad值），得到
 262   3                      采集到的ad值对应当前挡位的占比，再乘以当前挡位对应的百分比
 263   3                  */
 264   3                  ret = ((u32)fuel_adc_val - FUEL_LEVEL_1_ADC_VAL) * 18 / ((u32)FUEL_LEVEL_0_ADC_VAL - FUEL_LEVE
             -L_1_ADC_VAL);
 265   3                  ret = 18 - ret;
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 6   

 266   3              }
 267   2              else if (fuel_adc_val <= FUEL_LEVEL_1_ADC_VAL && fuel_adc_val > FUEL_LEVEL_2_ADC_VAL) /* 1格油
             -到2格油量，18% ~ 34% */
 268   2              {
 269   3                  ret = ((u32)fuel_adc_val - FUEL_LEVEL_2_ADC_VAL) * 34 / ((u32)FUEL_LEVEL_1_ADC_VAL - FUEL_LEVE
             -L_2_ADC_VAL);
 270   3                  ret = 34 - ret;
 271   3                  if (ret < 18)
 272   3                  {
 273   4                      ret = 18;
 274   4                  }
 275   3              }
 276   2              else if (fuel_adc_val <= FUEL_LEVEL_2_ADC_VAL && fuel_adc_val > FUEL_LEVEL_3_ADC_VAL) /* 2格油
             -到3格油量，34% ~ 51% */
 277   2              {
 278   3                  ret = ((u32)fuel_adc_val - FUEL_LEVEL_3_ADC_VAL) * 51 / ((u32)FUEL_LEVEL_2_ADC_VAL - FUEL_LEVE
             -L_3_ADC_VAL);
 279   3                  ret = 51 - ret;
 280   3                  if (ret < 34)
 281   3                  {
 282   4                      ret = 34;
 283   4                  }
 284   3              }
 285   2              else if (fuel_adc_val <= FUEL_LEVEL_3_ADC_VAL && fuel_adc_val > FUEL_LEVEL_4_ADC_VAL) /* 3格油
             -到4格油量，51% ~ 68% */
 286   2              {
 287   3                  ret = ((u32)fuel_adc_val - FUEL_LEVEL_4_ADC_VAL) * 68 / ((u32)FUEL_LEVEL_3_ADC_VAL - FUEL_LEVE
             -L_4_ADC_VAL);
 288   3                  ret = 68 - ret;
 289   3                  if (ret < 51)
 290   3                  {
 291   4                      ret = 51;
 292   4                  }
 293   3              }
 294   2              else if (fuel_adc_val <= FUEL_LEVEL_4_ADC_VAL && fuel_adc_val > FUEL_LEVEL_5_ADC_VAL) /* 4格油
             -到5格油量，68% ~ 84% */
 295   2              {
 296   3                  ret = ((u32)fuel_adc_val - FUEL_LEVEL_5_ADC_VAL) * 84 / ((u32)FUEL_LEVEL_4_ADC_VAL - FUEL_LEVE
             -L_5_ADC_VAL);
 297   3                  ret = 84 - ret;
 298   3                  if (ret < 68)
 299   3                  {
 300   4                      ret = 68;
 301   4                  }
 302   3              }
 303   2              else if (fuel_adc_val <= FUEL_LEVEL_5_ADC_VAL && fuel_adc_val > FUEL_LEVEL_6_ADC_VAL) /* 5格油
             -到6格油量，84% ~ 100.0% */
 304   2              {
 305   3                  ret = ((u32)fuel_adc_val - FUEL_LEVEL_6_ADC_VAL) * 100 / ((u32)FUEL_LEVEL_5_ADC_VAL - FUEL_LEV
             -EL_6_ADC_VAL);
 306   3                  ret = 100 - ret;
 307   3                  if (ret < 84)
 308   3                  {
 309   4                      ret = 84;
 310   4                  }
 311   3              }
 312   2          }
 313   1      
 314   1          // 0，显示0格，游标闪烁
 315   1          // 18以下，不含18，显示1格
 316   1          // ret = 18; // 18及以上，显示2格
 317   1          // ret = 34; // 34及以上，显示3格
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 7   

 318   1          // ret = 51; // 51及以上，显示4格
 319   1          // ret = 68; // 68及以上，显示5格
 320   1          // ret = 84; // 84及以上，显示6格
 321   1          return ret;
 322   1      #endif
 323   1      }
 324          
 325          enum
 326          {
 327              STATUS_JUST_POWER_ON = 0, // 刚上电
 328              STATUS_IN_SERVICE,        // 运行中
 329          };
 330          
 331          void fuel_capacity_scan(void)
 332          {
 333   1          u8 fuel_percent = 0;
 334   1          u16 fuel_adc_val = 0;
 335   1      
 336   1          adc_sel_pin(ADC_PIN_FUEL); // 内部至少占用1ms
 337   1          adc_val = adc_getval();    //
 338   1          fuel_adc_val = get_filtered_adc(adc_val);
 339   1          // printf("fuel_adc_val: %u\n", fuel_adc_val);
 340   1      
 341   1          // if (fuel_adc_val <= 4294967295 - 4095) // 防止计数溢出
 342   1          // {
 343   1          //     fuel_adc_val += adc_val;
 344   1          //     fuel_adc_scan_cnt++;
 345   1          // }
 346   1      
 347   1          /*
 348   1              刚上电直接获取一次，作为油量的状态
 349   1          */
 350   1          {
 351   2              static u8 status = STATUS_JUST_POWER_ON;
 352   2              if (STATUS_JUST_POWER_ON == status) // 如果是第一次上电
 353   2              {
 354   3                  if (fuel_capacity_scan_cnt >= FUEL_UPDATE_TIME_WHEN_POWER_ON)
 355   3                  {
 356   4                      fuel_capacity_scan_cnt = 0;
 357   4                      // fuel_adc_val /= fuel_adc_scan_cnt; // 求出扫描时间内得到的ad平均值
 358   4                      adc_val = adc_getval(); //
 359   4                      samples_init(adc_val);
 360   4                      fuel_adc_val = adc_val;
 361   4      
 362   4                      fuel_percent = convert_fuel_adc_to_percent(fuel_adc_val);
 363   4      
 364   4                      // printf("power on, fuel_percent:%bu\n", fuel_percent);
 365   4                      fun_info.fuel = fuel_percent;
 366   4                      // fuel_adc_scan_cnt = 0;
 367   4                      fuel_adc_val = 0;
 368   4                      flag_get_fuel = 1;
 369   4      
 370   4                      status = STATUS_IN_SERVICE;
 371   4                  }
 372   3              }
 373   2          }
 374   1      
 375   1          if (fuel_capacity_scan_cnt >= FUEL_UPDATE_TIME)
 376   1          {
 377   2              // 如果到了扫描更新时间
 378   2              fuel_capacity_scan_cnt = 0;
 379   2              // fuel_adc_val /= fuel_adc_scan_cnt; // 求出扫描时间内得到的ad平均值
C51 COMPILER V9.60.7.0   FUEL_CAPACITY                                                     07/11/2025 11:11:29 PAGE 8   

 380   2              // fuel_percent = convert_fuel_adc_to_percent(fuel_adc_val);
 381   2      
 382   2              fuel_percent = convert_fuel_adc_to_percent(fuel_adc_val);
 383   2      
 384   2              // printf("fuel_percent:%bu\n", fuel_percent);
 385   2              fun_info.fuel = fuel_percent;
 386   2              // fuel_adc_scan_cnt = 0;
 387   2              fuel_adc_val = 0;
 388   2              flag_get_fuel = 1;
 389   2          } //  if (fuel_capacity_scan_cnt >= FUEL_UPDATE_TIME)
 390   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    738    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     46      10
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
