C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        07/11/2025 11:11:28 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE KEY_DRIVER
OBJECT MODULE PLACED IN .\Release\Objects\key_driver.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\key_driver.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTO
                    -R(0X000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(
                    -.\Release\Listings\key_driver.lst) OBJECT(.\Release\Objects\key_driver.obj)

line level    source

   1          #include "key_driver.h"
   2          
   3          enum
   4          {
   5              KEY_SCAN_STATUS_NONE = 0,       // æ— ç‰¹æ®ŠçŠ¶æ€
   6              KEY_SCAN_STATUS_TO_NOTIFY,      // å‘é€æŒ‰é”®æ¶ˆæ¯
   7              KEY_SCAN_STATUS_TO_END_OF_SCAN, // æŒ‰é”®æ‰«æç»“æŸï¼Œè¿›è¡Œæ”¶å°¾å¤„ç†
   8          };
   9          
  10          static volatile u8 is_key_active = 0; // æŒ‰é”®æ˜¯å¦æœ‰æ•ˆçš„è®¡æ•°å€¼
  11          
  12          //=======================================================//
  13          // æŒ‰é”®æ‰«æå‡½æ•°: æ‰«ææ‰€æœ‰æ³¨å†Œçš„æŒ‰é”®é©±åŠ¨
  14          //=======================================================//
  15          // xdata volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€
             -è¦åŒæ ·å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
  16          volatile struct key_driver_para *scan_para; // è¦è®©æŒ‡é’ˆæŒ‡å‘xdataåŒºåŸŸçš„å…¨å±€å˜é‡ï¼Œéœ€è¦åŒæ ·
             -å°†æŒ‡é’ˆå˜ä¸ºå…¨å±€å˜é‡
  17          void key_driver_scan(void *_scan_para)
  18          // struct key_driver_para key_driver_scan(struct key_driver_para scan_para)
  19          {
  20   1          // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)_scan_para; // å
             -‡½æ•°å†…éƒ¨çš„æŒ‡é’ˆåªèƒ½æŒ‡å‘idataç©ºé—´ï¼Œä¸èƒ½æŒ‡å‘å…¨å±€å˜é‡çš„xdataç©ºé—´
  21   1          // volatile struct key_driver_para xdata *scan_para = (struct key_driver_para xdata *)0x642D; // ç³»ç»
             -Ÿä¼šä¸€ç›´å¤ä½
  22   1      
  23   1      #if 1
  24   1          u8 key_event = KEY_EVENT_NONE; // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®äº‹ä»¶
  25   1          u8 cur_key_value = NO_KEY;     // å­˜æ”¾å¾…å‘é€çš„æŒ‰é”®é”®å€¼
  26   1          u8 key_value = NO_KEY;
  27   1      
  28   1          // u8 key_scan_status = KEY_SCAN_STATUS_NONE; // çŠ¶æ€æœºï¼Œè´Ÿè´£æŽ§åˆ¶è¯¥å‡½æ•°å†…çš„è·³è½¬æ“ä½œ /
             -* æŽ§åˆ¶è·³è½¬è¿˜æœ‰é—®é¢˜ï¼Œè¿˜ä¸èƒ½ä½¿ç”¨ */
  29   1      
  30   1          scan_para = (struct key_driver_para *)_scan_para;
  31   1      
  32   1          // å¦‚æžœæ‰«ææ—¶é—´æœªåˆ°æ¥ï¼Œä¸æ‰§è¡ŒæŒ‰é”®æ‰«æ
  33   1          if (scan_para->cur_scan_times < scan_para->scan_times)
  34   1          {
  35   2              return;
  36   2          }
  37   1      
  38   1          scan_para->cur_scan_times = 0; // æ¸…ç©ºæ‰«ææ—¶é—´
  39   1      
  40   1          cur_key_value = scan_para->get_value(); // è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„èŽ·å–é”®å€¼å‡½æ•°
  41   1      
  42   1          // if (cur_key_value != NO_KEY)
  43   1          //     printf("key id %bu\n", cur_key_value); // æ‰“å°èŽ·å–åˆ°çš„é”®å€¼
  44   1      
  45   1          // åˆ¤æ–­æŒ‰é”®æ˜¯å¦æœ‰æ•ˆ
  46   1          if (cur_key_value != NO_KEY)
  47   1          {
  48   2              is_key_active = 35; // 35*10Ms
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        07/11/2025 11:11:28 PAGE 2   

  49   2          }
  50   1          else if (is_key_active)
  51   1          {
  52   2              is_key_active--;
  53   2          }
  54   1      
  55   1          // if (cur_key_value != NO_KEY)
  56   1          // {
  57   1          //     //     printf("scan_times %bu\n", scan_para->scan_times);
  58   1          //     //     printf("cur_scan_times %bu\n", scan_para->cur_scan_times);
  59   1          //     //     printf("last_key %bu\n", scan_para->last_key);
  60   1          //     //     printf("filter_value %bu\n", scan_para->filter_value);
  61   1          //     //     printf("filter_cnt %bu\n", scan_para->filter_cnt);
  62   1          //     //     printf("filter_time %bu\n", scan_para->filter_time);
  63   1          //     printf("long_time %bu\n", ad_key_para.long_time);
  64   1          //     printf("long_time %bu\n", (*scan_para).long_time);
  65   1          //     //     printf("hold_time %bu\n", scan_para->hold_time);
  66   1          //     //     printf("press_cnt %bu\n", scan_para->press_cnt);
  67   1      
  68   1          //     //     printf("click_cnt %bu\n", scan_para->click_cnt);
  69   1          //     //     printf("click_delay_cnt %bu\n", scan_para->click_delay_cnt);
  70   1          //     //     printf("click_delay_time %bu\n", scan_para->click_delay_time);
  71   1          //     //     printf("notify_value %bu\n", scan_para->notify_value);
  72   1          //     //     printf("key_type %bu\n", scan_para->key_type);
  73   1      
  74   1          //     //     printf("latest_key_val %bu\n", scan_para->latest_key_val);
  75   1          //     //     printf("latest_key_event %bu\n", scan_para->latest_key_event);
  76   1      
  77   1          //     printf("ad key long time addr %p\n", &ad_key_para.long_time);
  78   1          //     // printf("scan para long time addr %p\n", &(scan_para->long_time));
  79   1          //     printf("scan para long time addr %p\n", (*scan_para).long_time);
  80   1          // }
  81   1      
  82   1          //===== æŒ‰é”®æ¶ˆæŠ–å¤„ç†
  83   1          if (cur_key_value != scan_para->filter_value && scan_para->filter_time)
  84   1          {
  85   2              // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼å¦‚æžœä¸ç›¸ç­‰, é‡æ–°æ¶ˆæŠ–å¤„ç†, æ³¨æ„filter_time != 0
             -;
  86   2              scan_para->filter_cnt = 0;               // æ¶ˆæŠ–æ¬¡æ•°æ¸…0, é‡æ–°å¼€å§‹æ¶ˆæŠ–
  87   2              scan_para->filter_value = cur_key_value; // è®°å½•ä¸Šä¸€æ¬¡çš„æŒ‰é”®å€¼
  88   2              return;                                  // ç¬¬ä¸€æ¬¡æ£€æµ‹, è¿”å›žä¸åšå¤„ç†
  89   2          }
  90   1      
  91   1          // å½“å‰æŒ‰é”®å€¼ä¸Žä¸Šä¸€æ¬¡æŒ‰é”®å€¼ç›¸ç­‰, filter_cntå¼€å§‹ç´¯åŠ ;
  92   1          if (scan_para->filter_cnt < scan_para->filter_time)
  93   1          {
  94   2              scan_para->filter_cnt++;
  95   2              return;
  96   2          }
  97   1      
  98   1          //===== æŒ‰é”®æ¶ˆæŠ–ç»“æŸ, å¼€å§‹åˆ¤æ–­æŒ‰é”®ç±»åž‹(å•å‡», åŒå‡», é•¿æŒ‰, å¤šå‡», HOLD, (é•¿æŒ‰/HOL
             -D)æŠ¬èµ·)
  99   1          if (cur_key_value != scan_para->last_key)
 100   1          {
 101   2              /*
 102   2                  å¦‚æžœå½“å‰çš„é”®å€¼ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®æ
             -¾å¼€
 103   2                  cur_key = NO_KEY; last_key = valid_key -> æŒ‰é”®è¢«æŠ¬èµ·
 104   2              */
 105   2              // printf("key event up\n");
 106   2      
 107   2              if (cur_key_value == NO_KEY)
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        07/11/2025 11:11:28 PAGE 3   

 108   2              {
 109   3                  if (scan_para->press_cnt >= scan_para->long_time)
 110   3                  { // é•¿æŒ‰/HOLDçŠ¶æ€ä¹‹åŽè¢«æŒ‰é”®æŠ¬èµ·;
 111   4                      key_event = KEY_EVENT_UP;
 112   4                      key_value = scan_para->last_key;
 113   4                      goto _notify; // å‘é€æŠ¬èµ·æ¶ˆæ¯
 114   4                      // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY; // è·³è½¬åˆ°å‘é€æŒ‰é”®äº‹ä»¶çš„æ“ä½œ
 115   4                  }
 116   3      
 117   3                  // if (KEY_SCAN_STATUS_NONE == key_scan_status) // å¦‚æžœæ²¡æœ‰ç‰¹æ®Šæ“ä½œ
 118   3                  {
 119   4                      scan_para->click_delay_cnt = 1; // æŒ‰é”®ç­‰å¾…ä¸‹æ¬¡è¿žå‡»å»¶æ—¶å¼€å§‹
 120   4                  }
 121   3              }
 122   2              else
 123   2              {
 124   3                  /*
 125   3                      å¦‚æžœå½“å‰çš„é”®å€¼ä¸ä¸ºç©ºï¼Œä¸Šä¸€æ¬¡çš„é”®å€¼åˆä¸Žå½“å‰çš„é”®å€¼ä¸ä¸€æ ·ï¼Œè¯´æ˜Ž
             -æŒ‰é”®æŒ‰ä¸‹
 126   3                      cur_key = valid_key, last_key = NO_KEY -> æŒ‰é”®è¢«æŒ‰ä¸‹
 127   3                  */
 128   3                  scan_para->press_cnt = 1; // ç”¨äºŽåˆ¤æ–­longå’Œholdäº‹ä»¶çš„è®¡æ•°å™¨é‡æ–°å¼€å§‹è®¡æ—¶;
 129   3                  if (cur_key_value != scan_para->notify_value)
 130   3                  { // ç¬¬ä¸€æ¬¡å•å‡»/è¿žå‡»æ—¶æŒ‰ä¸‹çš„æ˜¯ä¸åŒæŒ‰é”®, å•å‡»æ¬¡æ•°é‡æ–°å¼€å§‹è®¡æ•°
 131   4                      scan_para->click_cnt = 1;
 132   4                      scan_para->notify_value = cur_key_value;
 133   4                  }
 134   3                  else
 135   3                  {
 136   4                      scan_para->click_cnt++; // å•å‡»æ¬¡æ•°ç´¯åŠ 
 137   4                  }
 138   3              }
 139   2      
 140   2              goto _scan_end; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 141   2              // if (KEY_SCAN_STATUS_NONE == key_scan_status)
 142   2              // {
 143   2              //     key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN; // è¿”å›ž, ç­‰å¾…å»¶æ—¶æ—¶é—´åˆ°
 144   2              // }
 145   2          }
 146   1          else
 147   1          {
 148   2              /*
 149   2                  å¦‚æžœå½“å‰èŽ·å–çš„é”®å€¼ä¸Žä¸Šæ¬¡èŽ·å–çš„é”®å€¼ä¸€æ ·ï¼Œè¯´æ˜ŽæŒ‰é”®åœ¨é•¿æŒ‰æˆ–æ˜¯æŒ‰é”®æ
             -œªæŒ‰ä¸‹
 150   2                  cur_key = last_key -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹/æŒ‰é”®é•¿æŒ‰(HOLD)
 151   2              */
 152   2              if (cur_key_value == NO_KEY)
 153   2              {
 154   3                  // last_key = NO_KEY; cur_key = NO_KEY -> æ²¡æœ‰æŒ‰é”®æŒ‰ä¸‹
 155   3                  if (scan_para->click_cnt > 0)
 156   3                  { // æœ‰æŒ‰é”®éœ€è¦æ¶ˆæ¯éœ€è¦å¤„ç†
 157   4      
 158   4                      // å¦‚æžœåªå“åº”å•å‡»äº‹ä»¶ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ /ä¿®æ”¹åŠŸèƒ½
 159   4      
 160   4                      if (scan_para->click_delay_cnt > scan_para->click_delay_time)
 161   4                      { // æŒ‰é”®è¢«æŠ¬èµ·åŽå»¶æ—¶åˆ°
 162   5                          // TODO: åœ¨æ­¤å¯ä»¥æ·»åŠ ä»»æ„å¤šå‡»äº‹ä»¶
 163   5                          // if (scan_para->click_cnt >= 5)
 164   5                          // {
 165   5                          //     key_event = KEY_EVENT_FIRTH_CLICK; // äº”å‡»
 166   5                          // }
 167   5                          // else if (scan_para->click_cnt >= 4)
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        07/11/2025 11:11:28 PAGE 4   

 168   5                          // {
 169   5                          //     key_event = KEY_EVENT_FOURTH_CLICK; // 4å‡»
 170   5                          // }
 171   5                          // else if (scan_para->click_cnt >= 3)
 172   5                          // {
 173   5                          //     key_event = KEY_EVENT_TRIPLE_CLICK; // ä¸‰å‡»
 174   5                          // }
 175   5                          // else if (scan_para->click_cnt >= 2)
 176   5                          // if (scan_para->click_cnt >= 2)
 177   5                          // {
 178   5                          //     key_event = KEY_EVENT_DOUBLE_CLICK; // åŒå‡»
 179   5                          // }
 180   5                          // else
 181   5                          {
 182   6                              key_event = KEY_EVENT_CLICK; // å•å‡»
 183   6                              // printf("click \n");
 184   6                          }
 185   5                          key_value = scan_para->notify_value;
 186   5      
 187   5                          goto _notify;
 188   5                          // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 189   5                      }
 190   4                      else
 191   4                      { // æŒ‰é”®æŠ¬èµ·åŽç­‰å¾…ä¸‹æ¬¡å»¶æ—¶æ—¶é—´æœªåˆ°
 192   5                          scan_para->click_delay_cnt++;
 193   5                          goto _scan_end; // æŒ‰é”®æŠ¬èµ·åŽå»¶æ—¶æ—¶é—´æœªåˆ°, è¿”å›ž
 194   5                          // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 195   5                      }
 196   4                  }
 197   3                  else
 198   3                  {
 199   4                      goto _scan_end; // æ²¡æœ‰æŒ‰é”®éœ€è¦å¤„ç†
 200   4                      // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 201   4                  }
 202   3              }
 203   2              else
 204   2              {
 205   3                  // last_key = valid_key; cur_key = valid_key, press_cntç´¯åŠ ç”¨äºŽåˆ¤æ–­longå’Œhold
 206   3                  if (scan_para->press_cnt < 255)
 207   3                  {
 208   4                      scan_para->press_cnt++;
 209   4                  }
 210   3      
 211   3                  // printf("long time %bu\n", scan_para->long_time);
 212   3                  // printf("press cnt %bu\n", scan_para->press_cnt);
 213   3                  if (scan_para->press_cnt == scan_para->long_time)
 214   3                  {
 215   4                      key_event = KEY_EVENT_LONG;
 216   4      
 217   4                      // printf("long time %bu\n", scan_para->long_time);
 218   4      
 219   4                      // printf("key event long\n");
 220   4                  }
 221   3                  else if (scan_para->press_cnt == scan_para->hold_time)
 222   3                  {
 223   4                      key_event = KEY_EVENT_HOLD;
 224   4                      scan_para->press_cnt = scan_para->long_time; // ä¸‹ä¸€æ¬¡scan_para->press_cnt++,è¿˜æ˜¯ä¼šè
             -¿›å…¥åˆ°è¿™é‡Œ
 225   4                      // printf("key event hold\n");
 226   4                  }
 227   3                  else
 228   3                  {
C51 COMPILER V9.60.7.0   KEY_DRIVER                                                        07/11/2025 11:11:28 PAGE 5   

 229   4                      goto _scan_end; // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, è¿”å›ž
 230   4                      // key_scan_status = KEY_SCAN_STATUS_TO_END_OF_SCAN;
 231   4                  }
 232   3      
 233   3                  // press_cntæ²¡åˆ°é•¿æŒ‰å’ŒHOLDæ¬¡æ•°, å‘æ¶ˆæ¯
 234   3                  key_value = cur_key_value;
 235   3                  goto _notify;
 236   3                  // key_scan_status = KEY_SCAN_STATUS_TO_NOTIFY;
 237   3              }
 238   2          }
 239   1      
 240   1      _notify:
 241   1      
 242   1          // if (KEY_SCAN_STATUS_TO_END_OF_SCAN != key_scan_status)
 243   1          {
 244   2              // if (KEY_TYPE_AD == scan_para->key_type) // å¦‚æžœæ˜¯adæŒ‰é”®
 245   2              {
 246   3                  scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 247   3                  scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 248   3      
 249   3                  scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 250   3                  scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 251   3      
 252   3                  // printf("notify\n");
 253   3              }
 254   2              // else if (KEY_TYPE_TOUCH == scan_para->key_type) // å¦‚æžœæ˜¯è§¦æ‘¸æŒ‰é”®
 255   2              // {
 256   2              //     scan_para->click_cnt = 0;         // æŒ‰ä¸‹æ¬¡æ•°æ¸…0
 257   2              //     scan_para->notify_value = NO_KEY; // åœ¨å»¶æ—¶çš„å¾…å‘é€æŒ‰é”®å€¼æ¸…é›¶
 258   2      
 259   2              //     scan_para->latest_key_val = key_value;   // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®é”®å€¼
 260   2              //     scan_para->latest_key_event = key_event; // å­˜æ”¾å¾—åˆ°çš„æŒ‰é”®äº‹ä»¶
 261   2              // }
 262   2          }
 263   1      
 264   1      _scan_end:
 265   1          scan_para->last_key = cur_key_value;
 266   1          return;
 267   1      #endif
 268   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    436    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4       2
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
