C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\
                    -Listings\main.lst) OBJECT(.\Release\Objects\main.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    main.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    05-11-2022
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           *
  11           * <h2><center>&copy; COPYRIGHT 2021 HUGE-IC</center></h2>
  12           *
  13           * ç‰ˆæƒè¯´æ˜åç»­è¡¥ä¸Š
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          /* Includes ------------------------------------------------------------------*/
  19          #include "include.h"
  20          #include "my_config.h"
  21          
  22          #if 0
              
              // æ›´æ–°æ—¶é—´
              // void time_update(void)
              // {
              //     if (tmr4_cnt >= 1000) // å¦‚æœè®¡æ—¶æ»¡1s(1000ms)
              //     {
              //         tmr4_cnt -= 1000; // ä¸ºäº†å°½é‡è®©æ—¶é—´å‡†ç¡®ï¼Œè¿™é‡Œæ˜¯ -=1000 ï¼Œè€Œä¸æ˜¯æ¸…é›¶
              
              //         if (fun_info.save_info.time_sec < 59) // æœ€å¤§åŠ åˆ°59sï¼Œæµ‹è¯•é€šè¿‡
              //         {
              //             fun_info.save_info.time_sec++;
              //         }
              //         else
              //         {
              //             fun_info.save_info.time_sec = 0;
              //             fun_info_save(); // æ¯åˆ†é’Ÿä¿å­˜ä¸€æ¬¡æ—¶é—´åˆ°flash
              
              //             // printf("cur min %d \n", (u16)fun_info.time_min);
              
              //             if (fun_info.save_info.time_min < 59) // æœ€å¤§åŠ åˆ°59minï¼Œæµ‹è¯•é€šè¿‡
              //             {
              //                 fun_info.save_info.time_min++;
              //             }
              //             else
              //             {
              //                 fun_info.save_info.time_min = 0;
              //                 // printf("cur hour %d \n", (u16)fun_info.time_hour);
              
              //                 if (fun_info.save_info.time_hour < 23) // æœ€å¤§åŠ åˆ°23hï¼Œæµ‹è¯•é€šè¿‡
              //                 {
              //                     fun_info.save_info.time_hour++;
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 2   

              //                 }
              //                 else
              //                 {
              //                     // åŠ åˆ° 23:59:59 åï¼Œå°†æ—¶é—´å…¨éƒ¨æ¸…é›¶
              //                     fun_info.save_info.time_hour = 0;
              //                     fun_info.save_info.time_min = 0;
              //                     fun_info.save_info.time_sec = 0;
              //                 }
              //             }
              //         }
              
              // #if USE_MY_DEBUG // æµ‹è¯•å•ç‰‡æœºå‘é€çš„æ•°æ®
              //         // printf("cur sec %d \n", (u16)fun_info.time_sec);
              
              //         // æµ‹è¯•ç”¨ï¼Œå¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹æ•°æ®ï¼Œç„¶åå‘é€
              //         {
              //             /*
              //                 #define TEST_SEND_BATTERY // æµ‹è¯•é€šè¿‡
              //                 #define TEST_SEND_BRAKE // MP5ä¸Šé¢æ²¡æœ‰æ˜¾ç¤ºï¼Œä¸²å£æœ‰å‘é€å¯¹åº”çš„æ•°æ®
              //                 #define TEST_SEND_LEFT_TURN // æµ‹è¯•é€šè¿‡
              //                 #define TEST_SEND_RIGHT_TURN // æµ‹è¯•é€šè¿‡
              //                 #define TEST_SEND_HIGH_BEAM // æµ‹è¯•é€šè¿‡
              
              //                 #define TEST_SEND_SPEED // æµ‹è¯•é€šè¿‡ï¼Œä½†æ˜¯è¦æ³¨æ„æ—¶é€Ÿçš„æ˜¾ç¤ºèŒƒå›´
              //                 #define TEST_SEND_ENGINE_SPEED // æµ‹è¯•é€šè¿‡
              //                 #define TEST_SEND_FUEL // æµ‹è¯•é€šè¿‡
              
              //                 #define TEST_SEND_TEMP_OF_WATER // æ²¡æœ‰æ˜¾ç¤ºï¼Œæ”¹ç”¨æ°´æ¸©æŠ¥è­¦
              //                 #define TEST_SEND_TOTAL_MILEAGE // æµ‹è¯•é€šè¿‡
              //                 #define TEST_SEND_SUBTOTAL_MILEAGE // æµ‹è¯•é€šè¿‡
              
              //                 #define TEST_SEND_TOUCH_KEY
              //                 #define TEST_SEND_TEMP_OF_WATER_WARNING // æµ‹è¯•é€šè¿‡
              //                 #define TEST_SEND_VOLTAGE_OF_BATTERY // æµ‹è¯•é€šè¿‡
              //             */
              
              //             // #define TEST_SEND_VOLTAGE_OF_BATTERY
              
              // #ifdef TEST_SEND_BATTERY
              //             // =============================================
              //             // æµ‹è¯•å‘é€ç”µæ± ç”µé‡--å•ä½ï¼šç™¾åˆ†æ¯”
              //             if (fun_info.battery < 100)
              //             {
              //                 fun_info.battery++;
              //             }
              //             else
              //             {
              //                 fun_info.battery = 0;
              //             }
              
              //             // printf("cur battery %d \%\n", (u16)fun_info.battery);
              //             flag_get_battery = 1;
              // #endif
              
              // #ifdef TEST_SEND_BRAKE
              //             // =============================================
              //             // æµ‹è¯•å‘é€ åˆ¹è½¦çŠ¶æ€
              //             if (fun_info.brake)
              //             {
              //                 fun_info.brake = 0;
              //             }
              //             else
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 3   

              //             {
              //                 fun_info.brake = 1;
              //             }
              
              //             flag_get_brake = 1;
              // #endif
              
              // #ifdef TEST_SEND_LEFT_TURN
              //             // =============================================
              //             // æµ‹è¯•å‘é€ å·¦è½¬å‘ç¯
              //             if (fun_info.left_turn)
              //             {
              //                 fun_info.left_turn = 0;
              //             }
              //             else
              //             {
              //                 fun_info.left_turn = 1;
              //             }
              
              //             flag_get_left_turn = 1;
              // #endif
              
              // #ifdef TEST_SEND_RIGHT_TURN
              //             // =============================================
              //             // æµ‹è¯•å‘é€ å³è½¬å‘ç¯
              //             if (fun_info.right_turn)
              //             {
              //                 fun_info.right_turn = 0;
              //             }
              //             else
              //             {
              //                 fun_info.right_turn = 1;
              //             }
              
              //             flag_get_right_turn = 1;
              // #endif
              
              // #ifdef TEST_SEND_HIGH_BEAM
              //             // #if 1
              //             // =============================================
              //             // æµ‹è¯•å‘é€ è¿œå…‰ç¯ çŠ¶æ€
              //             if (fun_info.high_beam)
              //             {
              //                 fun_info.high_beam = 0;
              //             }
              //             else
              //             {
              //                 fun_info.high_beam = 1;
              //             }
              
              //             flag_get_high_beam = 1;
              // #endif
              
              // #ifdef TEST_SEND_SPEED
              //             // =============================================
              //             // æµ‹è¯•å‘é€ æ—¶é€Ÿ
              //             if (fun_info.speed < 0xFFFF)
              //             {
              //                 fun_info.speed++;
              //             }
              //             else
              //             {
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 4   

              //                 fun_info.speed = 0;
              //             }
              
              //             flag_get_speed = 1;
              // #endif
              
              // #ifdef TEST_SEND_ENGINE_SPEED
              //             // =============================================
              //             // æµ‹è¯•å‘é€ å‘åŠ¨æœºè½¬é€Ÿ
              //             if (fun_info.engine_speeed < (0xFFFF - 1000))
              //             {
              //                 fun_info.engine_speeed += 1000;
              //             }
              //             else
              //             {
              //                 fun_info.engine_speeed = 1000;
              //             }
              
              //             flag_get_engine_speed = 1;
              // #endif
              
              // #ifdef TEST_SEND_FUEL
              //             // =============================================
              //             // æµ‹è¯•å‘é€ æ²¹é‡
              //             if (fun_info.fuel < 0xFF)
              //             {
              //                 fun_info.fuel++;
              //             }
              //             else
              //             {
              //                 fun_info.fuel = 0;
              //             }
              
              //             flag_get_fuel = 1;
              
              // #endif
              
              // #ifdef TEST_SEND_TEMP_OF_WATER
              //             // =============================================
              //             // æµ‹è¯•å‘é€ æ°´æ¸©
              //             if (fun_info.temp_of_water < 0xFF)
              //             {
              //                 fun_info.temp_of_water++;
              //             }
              //             else
              //             {
              //                 fun_info.temp_of_water = 0;
              //             }
              
              //             flag_get_temp_of_water = 1;
              // #endif
              
              // #ifdef TEST_SEND_TOTAL_MILEAGE
              //             // =============================================
              //             // æµ‹è¯•å‘é€ å¤§è®¡é‡Œç¨‹
              //             // fun_info.save_info.total_mileage = 90000;
              //             if (fun_info.save_info.total_mileage < (0xFFFFFFFF - 1000))
              //             {
              //                 fun_info.save_info.total_mileage += 1000;
              //             }
              //             else
              //             {
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 5   

              //                 fun_info.save_info.total_mileage = 0xFFFF0000;
              //             }
              
              //             flag_get_total_mileage = 1;
              
              // #endif
              
              // #ifdef TEST_SEND_SUBTOTAL_MILEAGE
              //             // =============================================
              //             // æµ‹è¯•å‘é€ å°è®¡é‡Œç¨‹
              //             if (fun_info.save_info.subtotal_mileage < 1000)
              //             {
              //                 fun_info.save_info.subtotal_mileage++;
              //             }
              //             else
              //             {
              //                 fun_info.save_info.subtotal_mileage = 0;
              //             }
              
              //             flag_get_sub_total_mileage = 1;
              // #endif
              
              // #ifdef TEST_SEND_TEMP_OF_WATER_WARNING
              //             // =============================================
              //             // æµ‹è¯•å‘é€ æ°´æ¸©æŠ¥è­¦
              
              //             if (fun_info.flag_is_in_water_temp_warning)
              //             {
              //                 fun_info.flag_is_in_water_temp_warning = 0;
              //             }
              //             else
              //             {
              //                 fun_info.flag_is_in_water_temp_warning = 1;
              //             }
              
              //             flag_set_temp_of_water_warning = 1;
              // #endif
              
              // #ifdef TEST_SEND_VOLTAGE_OF_BATTERY
              //             // æµ‹è¯• å‘é€ç”µæ± ç”µå‹
              //             if (fun_info.voltage_of_battery < (0xFFFF - 10))
              //             {
              //                 fun_info.voltage_of_battery += 10;
              //             }
              //             else
              //             {
              //                 fun_info.voltage_of_battery = 10000;
              //             }
              
              //             flag_get_voltage_of_battery = 1;
              // #endif
              //         }
              
              // #endif // #if USE_MY_DEBUG // æµ‹è¯•å•ç‰‡æœºå‘é€çš„æ•°æ®
              //     }
              // }
              #endif
 297          
 298          // DEBUG
 299          // volatile bit flag_is_debug_update = 0; // æµ‹è¯•æ—¶ä½¿ç”¨
 300          volatile bit flag_debug_is_send_time = 0; // æµ‹è¯•æ—¶ä½¿ç”¨
 301          
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 6   

 302          void user_init(void)
 303          {
 304   1          // æ§åˆ¶ä¸Šç”µæŒ‡ç¤ºç¯çš„å¼•è„šï¼š
 305   1          P2_MD0 &= ~(GPIO_P23_MODE_SEL(0x03)); // æ¸…ç©ºå¯„å­˜å™¨é…ç½®
 306   1          P2_MD0 |= GPIO_P23_MODE_SEL(0x01);    // è¾“å‡ºæ¨¡å¼
 307   1          FOUT_S23 |= GPIO_FOUT_AF_FUNC;
 308   1      
 309   1          fun_info_init(); // åˆå§‹åŒ–ç”¨äºå­˜æ”¾ä¿¡æ¯çš„å˜é‡
 310   1      
 311   1          tmr0_config();  // ä¸²å£æ£€æµ‹æ•°æ®è¶…æ—¶éœ€è¦ä½¿ç”¨åˆ°çš„å®šæ—¶å™¨
 312   1          uart0_config(); // å‘é€å’Œæ¥æ”¶æŒ‡ä»¤ä½¿ç”¨åˆ°çš„ä¸²å£
 313   1      
 314   1      #if PIN_LEVEL_SCAN_ENABLE
 315   1          pin_level_scan_config(); // åˆ¹è½¦ã€è½¬å‘ç¯ã€æŒ¡ä½çš„æ£€æµ‹å¼•è„šé…ç½®
 316   1      #endif
 317   1      
 318   1          tmr1_config(); // æ£€æµ‹ä¸€æ®µæ—¶é—´å†…çš„è„‰å†²ä¸ªæ•°æ‰€éœ€çš„å®šæ—¶å™¨(ç”¨äºè®¡æ—¶)
 319   1      
 320   1      #if SPEED_SCAN_ENABLE
 321   1          speed_scan_config(); // æ—¶é€Ÿæ‰«æçš„é…ç½®
 322   1      #endif                   // SPEED_SCAN_ENABLE
 323   1      
 324   1      #if ENGINE_SPEED_SCAN_ENABLE
 325   1          engine_speed_scan_config(); // å‘åŠ¨æœºè½¬é€Ÿæ‰«æçš„é…ç½®
 326   1      #endif                          // #if ENGINE_SPEED_SCAN_ENABLE
 327   1      
 328   1      #if (BATTERY_SCAN_ENABLE || AD_KEY_ENABLE || FUEL_CAPACITY_SCAN_ENABLE || TEMP_OF_WATER_SCAN_ENABLE)
 329   1          adc_config();
 330   1      #endif
 331   1      
 332   1      #if TOUCH_KEY_ENABLE
 333   1          tk_param_init(); // è§¦æ‘¸æŒ‰é”®æ¨¡å—åˆå§‹åŒ–
 334   1      #endif
 335   1      
 336   1      #if IC_1302_ENABLE
 337   1          aip1302_config(); // åˆå§‹åŒ–æ—¶é’Ÿicï¼Œå‡½æ•°å†…éƒ¨ä¼šè¯»å–æ—¶é—´ä¿¡æ¯ï¼Œå¹¶å­˜æ”¾åˆ°å…¨å±€å˜é‡ä
             -¸­
 338   1      #endif
 339   1      
 340   1          tmr2_config(); // æ‰«æè„‰å†²(ç”µå¹³å˜åŒ–)çš„å®šæ—¶å™¨
 341   1      
 342   1          // tmr1_enable(); // æ‰“å¼€ æ£€æµ‹å¼•è„šç”µå¹³ã€æ£€æµ‹æ—¶é€Ÿã€å‘åŠ¨æœºè½¬é€Ÿã€æ›´æ–°é‡Œç¨‹ã€å®šæ—
             -¶æ£€æµ‹æ²¹é‡ ä½¿ç”¨çš„å®šæ—¶å™¨ ã€ç°åœ¨ç›´æ¥æ”¾åˆ°äº†tmr1_config()å‡½æ•°ä¸­ã€‘
 343   1          tmr2_enable(); // æ‰“å¼€å®šæ—¶æ£€æµ‹è„‰å†²çš„å®šæ—¶å™¨
 344   1      
 345   1          // delay_ms(10); // ç­‰å¾…ç³»ç»Ÿç¨³å®š
 346   1          // tk_param_init();  // è§¦æ‘¸æŒ‰é”®æ¨¡å—åˆå§‹åŒ–
 347   1          delay_ms(1); // ç­‰å¾…ç³»ç»Ÿç¨³å®š
 348   1          // delay_ms(2000); // ç­‰å¾…ç³»ç»Ÿç¨³å®š
 349   1      }
 350          
 351          void main(void)
 352          {
 353   1          // çœ‹é—¨ç‹—é»˜è®¤æ‰“å¼€, å¤ä½æ—¶é—´2s
 354   1          system_init();
 355   1      
 356   1          // WDT_KEY = WDT_KEY_VAL(0xDD); //  å…³é—­çœ‹é—¨ç‹—
 357   1      
 358   1          // å…³é—­HCKå’ŒHDAçš„è°ƒè¯•åŠŸèƒ½
 359   1          WDT_KEY = 0x55;  // è§£é™¤å†™ä¿æŠ¤
 360   1          IO_MAP &= ~0x01; // æ¸…é™¤è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå®ç°å…³é—­HCKå’ŒHDAå¼•è„šçš„è°ƒè¯•åŠŸèƒ½ï¼ˆè§£é™¤æ
             -˜ å°„ï¼‰
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 7   

 361   1          WDT_KEY = 0xBB;
 362   1      
 363   1          /* ç”¨æˆ·ä»£ç åˆå§‹åŒ–æ¥å£ */
 364   1          user_init();
 365   1      
 366   1          // æµ‹è¯•ç”¨åˆ°çš„é…ç½®ï¼š
 367   1          // P1_MD0 &= (~GPIO_P11_MODE_SEL(0x3));
 368   1          // P1_MD0 |= GPIO_P11_MODE_SEL(0x1); // è¾“å‡ºæ¨¡å¼
 369   1          // FOUT_S11 |= GPIO_FOUT_AF_FUNC;
 370   1          // P11 = 0;
 371   1          // P2_MD0 &= ~GPIO_P20_MODE_SEL(0x3); // æ¸…ç©ºå¯¹åº”çš„é…ç½®
 372   1          // P2_MD0 |= GPIO_P20_MODE_SEL(0x1);  // è¾“å‡ºæ¨¡å¼
 373   1          // FOUT_S20 |= GPIO_FOUT_AF_FUNC;
 374   1          // P20 = 0;
 375   1      
 376   1          // printf("sys reset\n");
 377   1      
 378   1          // ä¸Šç”µåï¼Œéœ€è¦ç‚¹äº®ä¸€ä¸‹æ‰€æœ‰çš„æŒ‡ç¤ºç¯ï¼Œå†å…³é—­:
 379   1          P23 = 1;
 380   1          delay_ms(1000);
 381   1          P23 = 0;
 382   1      
 383   1          // printf("scan_times %bu\n", ad_key_para.scan_times);
 384   1          // printf("cur_scan_times %bu\n", ad_key_para.cur_scan_times);
 385   1          // printf("last_key %bu\n", ad_key_para.last_key);
 386   1          // printf("filter_value %bu\n", ad_key_para.filter_value);
 387   1          // printf("filter_cnt %bu\n", ad_key_para.filter_cnt);
 388   1          // printf("filter_time %bu\n", ad_key_para.filter_time);
 389   1          // printf("long_time %bu\n", ad_key_para.long_time);
 390   1          // printf("hold_time %bu\n", ad_key_para.hold_time);
 391   1          // printf("press_cnt %bu\n", ad_key_para.press_cnt);
 392   1      
 393   1          // printf("click_cnt %bu\n", ad_key_para.click_cnt);
 394   1          // printf("click_delay_cnt %bu\n", ad_key_para.click_delay_cnt);
 395   1          // printf("click_delay_time %bu\n", ad_key_para.click_delay_time);
 396   1          // printf("notify_value %bu\n", ad_key_para.notify_value);
 397   1          // printf("key_type %bu\n", ad_key_para.key_type);
 398   1      
 399   1          // printf("latest_key_val %bu\n", ad_key_para.latest_key_val);
 400   1          // printf("latest_key_event %bu\n", ad_key_para.latest_key_event);
 401   1      
 402   1          // printf("size %bu\n", (u8)sizeof(struct key_driver_para_t *));
 403   1          // printf("addr %p\n", (void *)&ad_key_para);
 404   1      
 405   1      #if 0  // æµ‹è¯•å‘é€æ—¥æœŸå’Œæ—¶é—´
                  // å½“å‰æ—¥æœŸ
                  fun_info.aip1302_saveinfo.year = 2024;
                  fun_info.aip1302_saveinfo.month = 12;
                  fun_info.aip1302_saveinfo.day = 05;
              
                  // å½“å‰æ—¶é—´
                  fun_info.aip1302_saveinfo.time_hour = 13;
                  fun_info.aip1302_saveinfo.time_min = 45;
                  fun_info.aip1302_saveinfo.time_sec = 32;
              
                  aip1302_update_all_data(fun_info.aip1302_saveinfo);
              
                  printf("year %u month %bu day %bu \n", fun_info.aip1302_saveinfo.year, fun_info.aip1302_saveinfo.month
             -, fun_info.aip1302_saveinfo.day);
                  printf("hour %bu min %bu sec %bu \n", fun_info.aip1302_saveinfo.time_hour, fun_info.aip1302_saveinfo.t
             -ime_min, fun_info.aip1302_saveinfo.time_sec);
              #endif // æµ‹è¯•å‘é€æ—¥æœŸå’Œæ—¶é—´
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 8   

 421   1      
 422   1          // printf("sys reset\n");
 423   1      
 424   1          // æµ‹è¯•ç¨‹åºï¼š
 425   1          // fun_info.save_info.total_mileage = (u32)999970 * 1000;
 426   1          // // fun_info.save_info.subtotal_mileage = (u32)999970 * 100;
 427   1          // fun_info.save_info.subtotal_mileage = (u32)99997 * 100;
 428   1          // // fun_info.save_info.subtotal_mileage = (u32)10051 * 100;
 429   1          // fun_info.save_info.subtotal_mileage_2 = (u32)999970 * 100;
 430   1      
 431   1          /* ç³»ç»Ÿä¸»å¾ªç¯ */
 432   1          while (1)
 433   1          {
 434   2              // printf("main circle\n");
 435   2      
 436   2      #if 1
 437   2              WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
 438   2      
 439   2      #if TOUCH_KEY_ENABLE
 440   2              /* æŒ‰é”®æ‰«æå‡½æ•° */
 441   2              __tk_scan();                 // ä½¿ç”¨äº†åº“é‡Œé¢çš„æ¥å£ï¼ˆé—­æºåº“ï¼‰
 442   2              WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
 443   2      #endif
 444   2      
 445   2      #if AD_KEY_ENABLE
 446   2              key_driver_scan(&ad_key_para);
 447   2              ad_key_handle(); // adæŒ‰é”®å¤„ç†å‡½æ•°
 448   2      #endif                   //  #if AD_KEY_ENABLE
 449   2      
 450   2      #if TOUCH_KEY_ENABLE
 451   2              key_driver_scan(&touch_key_para);
 452   2              touch_key_handle(); // è§¦æ‘¸æŒ‰é”®å¤„ç†å‡½æ•°
 453   2      #endif
 454   2      #if PIN_LEVEL_SCAN_ENABLE
 455   2              pin_level_scan();
 456   2      #endif
 457   2      #if SPEED_SCAN_ENABLE
 458   2      
 459   2              speed_scan();      // æ£€æµ‹æ—¶é€Ÿ
 460   2              speed_send_data(); // å‘é€æ—¶é€Ÿæ•°æ®ï¼Œéœ€è¦æ—¶é—´åˆ°æ¥æ‰ä¼šæ‰§è¡Œ
 461   2      
 462   2      #if 0 // è°ƒè¯•ä½¿ç”¨
                      if (flag_debug_is_send_time)
                      {
                          static u16 tmp = 0;
                          tmp += 10;
                          if (tmp >= 200)
                          {
                              tmp = 0;
                          }
              
                          fun_info.speed = tmp;
                          // fun_info.speed = 140;
                          flag_get_speed = 1;
                      }
              #endif
 477   2      
 478   2      #endif // #if SPEED_SCAN_ENABLE
 479   2      
 480   2      #if ENGINE_SPEED_SCAN_ENABLE
 481   2              engine_speed_scan();      // æ£€æµ‹å‘åŠ¨æœºè½¬é€Ÿ
 482   2              engine_speed_send_data(); // å‘åŠ¨å‘åŠ¨æœºè½¬é€Ÿæ•°æ®ï¼Œéœ€è¦æ—¶é—´åˆ°æ¥æ‰ä¼šæ‰§è¡Œ
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 9   

 483   2      
 484   2      #endif // #if ENGINE_SPEED_SCAN_ENABLE
 485   2      
 486   2              mileage_scan(); // æ£€æµ‹å¤§è®¡é‡Œç¨‹å’Œå°è®¡é‡Œç¨‹
 487   2      
 488   2      #if FUEL_CAPACITY_SCAN_ENABLE
 489   2              fuel_capacity_scan(); // æ²¹é‡æ£€æµ‹
 490   2      #endif                        // FUEL_CAPACITY_SCAN_ENABLE
 491   2      #if BATTERY_SCAN_ENABLE
 492   2              battery_scan(); // ç”µæ± ç”µé‡æ£€æµ‹
 493   2      #endif                  // BATTERY_SCAN_ENABLE
 494   2      
 495   2      #if 0
                      // DEBUG
                      if (flag_is_debug_update)
                      {
                          flag_is_debug_update = 0;
              
                          // fun_info.fuel++;
                          // if (fun_info.fuel > 100)
                          // {
                          //     fun_info.fuel = 0;
                          // }
              
                          // {
                          //     static u16 cnt = 0;
                          //     if (cnt < 4095 - 100)
                          //     {
                          //         cnt += 100;
                          //         fuel_adc_val = cnt;
                          //     }
                          //     else
                          //     {
                          //         cnt = 0;
                          //         fuel_adc_val = cnt;
                          //     }
              
                          //     // flag_get_fuel = 1;
                          // }
              
                          fun_info.save_info.total_mileage += 1000;
                          flag_get_total_mileage = 1;
              
                          fun_info.save_info.subtotal_mileage += 1000;
                          flag_get_sub_total_mileage = 1;
              
                          fun_info.save_info.subtotal_mileage_2 += 1000;
                          flag_get_sub_total_mileage_2 = 1;
              
                          fun_info.engine_speeed += 100;
                          flag_get_engine_speed = 1;
              
                          {
                              static u8 cnt = 0;
              
                              fun_info.speed = cnt;
                              cnt++;
                              if (cnt >= 255)
                              {
                                  cnt = 0;
                              }
              
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 10  

                              flag_get_speed = 1;
                          } 
              
                          {
                              static u8 fuel_percent = 0;
              
                              /*
                                  è®°å½•ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„æ²¹é‡æŒ¡ä½
                                  ç”¨äºæ§åˆ¶æ¯éš” 40s æ›´æ–°ä¸€æ¬¡æ²¹é‡çš„æ ¼æ•°ï¼Œ0~6æ ¼æ²¹é‡
                              */
                              static u8 fuel_gear = 0;
              
                              if (fuel_capacity_scan_cnt >= 40000)
                              // if (fuel_capacity_scan_cnt >= 4000)
                              {
                                  u8 cur_fuel_gear = 0;
                                  u8 i;
                                  // å¦‚æœåˆ°äº†æ‰«ææ›´æ–°æ—¶é—´
                                  fuel_capacity_scan_cnt = 0;
              
                                  fuel_gear++;
                                  if (fuel_gear > 6)
                                  {
                                      fuel_gear = 0;
                                  }
              
                                  for (i = 0; i < 255; i++)
                                  {
                                      extern u8 convert_fuel_percent_to_gear(u8 fuel_percent); 
                                      u8 tmp = convert_fuel_percent_to_gear(i);
                                      if (tmp == fuel_gear)
                                      {
                                          fuel_percent = i; // å¾—åˆ°å˜åŒ–ä¸€ä¸ªæŒ¡ä½åå¯¹åº”çš„æ²¹é‡ç™¾åˆ†æ¯”
                                          break;
                                      }
                                  }
              
                              } //  if (fuel_capacity_scan_cnt >= FUEL_UPDATE_TIME)
              
                              fun_info.fuel = fuel_percent;
                              flag_get_fuel = 1; // å‘é€æ²¹é‡ç™¾åˆ†æ¯”æ•°æ®
                          }
                      }
              #endif
 589   2      
 590   2              uart0_scan_handle();  // æ£€æŸ¥ä¸²å£æ¥æ”¶ç¼“å†²åŒºçš„æ•°æ®æ˜¯å¦ç¬¦åˆåè®®,å¦‚æœæœ‰æ­£ç¡®çš„
             -æŒ‡ä»¤ï¼Œä¼šå­˜åˆ°å¦ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼ˆæ¥ä¸‹æ¥è®©instruction_scan()å‡½æ•°æ¥å¤„ç†ï¼‰
 591   2              instruction_scan();   // æ‰«ææ˜¯å¦æœ‰åˆæ³•çš„æŒ‡ä»¤
 592   2              instruction_handle(); // æ‰«ææ˜¯å¦æœ‰å¯¹åº”çš„è·å–/çŠ¶æ€æ›´æ–°æ“ä½œ(æœ€å ç”¨æ—¶é—´,å› ä¸ºè
             -¦ç­‰å¾…ä¸²å£çš„æ•°æ®å‘é€å®Œæˆ)
 593   2      
 594   2      #endif //
 595   2      
 596   2              // aip1302_test();
 597   2              // {
 598   2              //     u8 ret = 0;
 599   2              //     ret = aip1302_is_running();
 600   2              //     if (ret)
 601   2              //     {
 602   2              //         // å¦‚æœæ—¶é’ŸèŠ¯ç‰‡aip1302çš„æ™¶æŒ¯æ­£åœ¨è¿è¡Œ
 603   2              //         printf("aip1302 is running\n");
 604   2              //     }
C51 COMPILER V9.60.7.0   MAIN                                                              08/02/2025 16:49:14 PAGE 11  

 605   2              //     else
 606   2              //     {
 607   2              //         // å¦‚æœæ—¶é’ŸèŠ¯ç‰‡aip1302çš„æ™¶æŒ¯ä¸åœ¨è¿è¡Œ
 608   2              //         printf("aip1302 is sleep\n");
 609   2              //     }
 610   2              // }
 611   2      
 612   2              // AIP1302_CE_PIN = 1;
 613   2              // delay_ms(500);
 614   2              // AIP1302_CE_PIN = 0;
 615   2              // delay_ms(500);
 616   2      
 617   2      #if 0
                      if (flag_debug_is_send_time)
                      {
                          flag_debug_is_send_time = 0;
                          aip1302_read_all();
                          printf("year %u \n", fun_info.aip1302_saveinfo.year);
                          printf("month %bu \n", fun_info.aip1302_saveinfo.month);
                          printf("day %bu \n", fun_info.aip1302_saveinfo.day);
                          printf("hour %bu \n", fun_info.aip1302_saveinfo.time_hour);
                          printf("min %bu \n", fun_info.aip1302_saveinfo.time_min);
                          printf("sec %bu \n", fun_info.aip1302_saveinfo.time_sec);
                      }
              #endif
 630   2      
 631   2              // heart_beat_handle(); //
 632   2      
 633   2              WDT_KEY = WDT_KEY_VAL(0xAA); // å–‚ç‹—å¹¶æ¸…é™¤ wdt_pending
 634   2          }
 635   1      }
 636          
 637          /**
 638           * @}
 639           */
 640          
 641          /*************************** (C) COPYRIGHT 2022 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    159    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
