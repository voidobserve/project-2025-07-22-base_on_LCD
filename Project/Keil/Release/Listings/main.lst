C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X000C) 
                    -INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Release\
                    -Listings\main.lst) OBJECT(.\Release\Objects\main.obj)

line level    source

   1          /**
   2           ******************************************************************************
   3           * @file    main.c
   4           * @author  HUGE-IC Application Team
   5           * @version V1.0.0
   6           * @date    05-11-2022
   7           * @brief   Main program body
   8           ******************************************************************************
   9           * @attention
  10           *
  11           * <h2><center>&copy; COPYRIGHT 2021 HUGE-IC</center></h2>
  12           *
  13           * ÁâàÊùÉËØ¥ÊòéÂêéÁª≠Ë°•‰∏ä
  14           *
  15           ******************************************************************************
  16           */
  17          
  18          /* Includes ------------------------------------------------------------------*/
  19          #include "include.h"
  20          #include "my_config.h"
  21          
  22          // DEBUG
  23          // volatile bit flag_is_debug_update = 0; // ÊµãËØïÊó∂‰ΩøÁî®
  24          volatile bit flag_debug_is_send_time = 0; // ÊµãËØïÊó∂‰ΩøÁî®
  25          // volatile bit flag_debug_is_send_time_2 = 0; // ÊµãËØïÊó∂‰ΩøÁî®
  26          
  27          void user_init(void)
  28          {
  29   1          // ÊéßÂà∂‰∏äÁîµÊåáÁ§∫ÁÅØÁöÑÂºïËÑöÔºö
  30   1          P2_MD0 &= ~(GPIO_P23_MODE_SEL(0x03)); // Ê∏ÖÁ©∫ÂØÑÂ≠òÂô®ÈÖçÁΩÆ
  31   1          P2_MD0 |= GPIO_P23_MODE_SEL(0x01);    // ËæìÂá∫Ê®°Âºè
  32   1          FOUT_S23 |= GPIO_FOUT_AF_FUNC;
  33   1      
  34   1          
  35   1      
  36   1          // tmr0_config();  // ‰∏≤Âè£Ê£ÄÊµãÊï∞ÊçÆË∂ÖÊó∂ÈúÄË¶Å‰ΩøÁî®Âà∞ÁöÑÂÆöÊó∂Âô®
  37   1          uart0_config(); // ÂèëÈÄÅÂíåÊé•Êî∂Êåá‰ª§‰ΩøÁî®Âà∞ÁöÑ‰∏≤Âè£
  38   1      
  39   1      #if PIN_LEVEL_SCAN_ENABLE
                  pin_level_scan_config(); // ÂàπËΩ¶„ÄÅËΩ¨ÂêëÁÅØ„ÄÅÊå°‰ΩçÁöÑÊ£ÄÊµãÂºïËÑöÈÖçÁΩÆ
              #endif
  42   1      
  43   1          tmr1_config(); // Ê£ÄÊµã‰∏ÄÊÆµÊó∂Èó¥ÂÜÖÁöÑËÑâÂÜ≤‰∏™Êï∞ÊâÄÈúÄÁöÑÂÆöÊó∂Âô®(Áî®‰∫éËÆ°Êó∂)
  44   1      
  45   1      #if SPEED_SCAN_ENABLE
  46   1          speed_scan_config(); // Êó∂ÈÄüÊâ´ÊèèÁöÑÈÖçÁΩÆ
  47   1      #endif                   // SPEED_SCAN_ENABLE
  48   1      
  49   1      #if ENGINE_SPEED_SCAN_ENABLE
                  engine_speed_scan_config(); // ÂèëÂä®Êú∫ËΩ¨ÈÄüÊâ´ÊèèÁöÑÈÖçÁΩÆ
              #endif                          // #if ENGINE_SPEED_SCAN_ENABLE
  52   1      
  53   1      #if (BATTERY_SCAN_ENABLE || AD_KEY_ENABLE || FUEL_CAPACITY_SCAN_ENABLE || TEMP_OF_WATER_SCAN_ENABLE)
C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 2   

                  adc_config();
              #endif
  56   1      
  57   1      #if TOUCH_KEY_ENABLE
                  tk_param_init(); // Ëß¶Êë∏ÊåâÈîÆÊ®°ÂùóÂàùÂßãÂåñ
              #endif
  60   1      
  61   1      #if IC_1302_ENABLE
                  aip1302_config(); // ÂàùÂßãÂåñÊó∂ÈíüicÔºåÂáΩÊï∞ÂÜÖÈÉ®‰ºöËØªÂèñÊó∂Èó¥‰ø°ÊÅØÔºåÂπ∂Â≠òÊîæÂà∞ÂÖ®Â±ÄÂèòÈáè‰
             -∏≠
              #endif
  64   1      
  65   1          tmr2_config(); // Êâ´ÊèèËÑâÂÜ≤(ÁîµÂπ≥ÂèòÂåñ)ÁöÑÂÆöÊó∂Âô®
  66   1      
  67   1          // tmr1_enable(); // ÊâìÂºÄ Ê£ÄÊµãÂºïËÑöÁîµÂπ≥„ÄÅÊ£ÄÊµãÊó∂ÈÄü„ÄÅÂèëÂä®Êú∫ËΩ¨ÈÄü„ÄÅÊõ¥Êñ∞ÈáåÁ®ã„ÄÅÂÆöÊó
             -∂Ê£ÄÊµãÊ≤πÈáè ‰ΩøÁî®ÁöÑÂÆöÊó∂Âô® „ÄêÁé∞Âú®Áõ¥Êé•ÊîæÂà∞‰∫Ütmr1_config()ÂáΩÊï∞‰∏≠„Äë
  68   1          // tmr2_enable(); // ÊâìÂºÄÂÆöÊó∂Ê£ÄÊµãËÑâÂÜ≤ÁöÑÂÆöÊó∂Âô®
  69   1      
  70   1          iic_config();
  71   1      
  72   1          fun_info_init(); // ÂàùÂßãÂåñÁî®‰∫éÂ≠òÊîæ‰ø°ÊÅØÁöÑÂèòÈáèÔºàË¶ÅÊîæÂú®iicÂàùÂßãÂåñÂêéÈù¢Ôºâ
  73   1      
  74   1          // delay_ms(10); // Á≠âÂæÖÁ≥ªÁªüÁ®≥ÂÆö
  75   1          // tk_param_init();  // Ëß¶Êë∏ÊåâÈîÆÊ®°ÂùóÂàùÂßãÂåñ
  76   1          delay_ms(1); // Á≠âÂæÖÁ≥ªÁªüÁ®≥ÂÆö
  77   1          // delay_ms(2000); // Á≠âÂæÖÁ≥ªÁªüÁ®≥ÂÆö
  78   1      }
  79          
  80          void main(void)
  81          {
  82   1          // ÁúãÈó®ÁãóÈªòËÆ§ÊâìÂºÄ, Â§ç‰ΩçÊó∂Èó¥2s
  83   1          system_init();
  84   1      
  85   1          // WDT_KEY = WDT_KEY_VAL(0xDD); //  ÂÖ≥Èó≠ÁúãÈó®Áãó
  86   1      
  87   1          // ÂÖ≥Èó≠HCKÂíåHDAÁöÑË∞ÉËØïÂäüËÉΩ
  88   1          WDT_KEY = 0x55;  // Ëß£Èô§ÂÜô‰øùÊä§
  89   1          IO_MAP &= ~0x01; // Ê∏ÖÈô§Ëøô‰∏™ÂØÑÂ≠òÂô®ÁöÑÂÄºÔºåÂÆûÁé∞ÂÖ≥Èó≠HCKÂíåHDAÂºïËÑöÁöÑË∞ÉËØïÂäüËÉΩÔºàËß£Èô§Ê
             -ò†Â∞ÑÔºâ
  90   1          WDT_KEY = 0xBB;
  91   1      
  92   1          /* Áî®Êà∑‰ª£Á†ÅÂàùÂßãÂåñÊé•Âè£ */
  93   1          user_init();
  94   1      
  95   1          // ÊµãËØïÁî®Âà∞ÁöÑÈÖçÁΩÆÔºö
  96   1          // P1_MD0 &= (~GPIO_P11_MODE_SEL(0x3));
  97   1          // P1_MD0 |= GPIO_P11_MODE_SEL(0x1); // ËæìÂá∫Ê®°Âºè
  98   1          // FOUT_S11 |= GPIO_FOUT_AF_FUNC;
  99   1          // P11 = 0;
 100   1          // P2_MD0 &= ~GPIO_P20_MODE_SEL(0x3); // Ê∏ÖÁ©∫ÂØπÂ∫îÁöÑÈÖçÁΩÆ
 101   1          // P2_MD0 |= GPIO_P20_MODE_SEL(0x1);  // ËæìÂá∫Ê®°Âºè
 102   1          // FOUT_S20 |= GPIO_FOUT_AF_FUNC;
 103   1          // P20 = 0;
 104   1      
 105   1          // printf("sys reset\n");
 106   1      
 107   1          // ‰∏äÁîµÂêéÔºåÈúÄË¶ÅÁÇπ‰∫Æ‰∏Ä‰∏ãÊâÄÊúâÁöÑÊåáÁ§∫ÁÅØÔºåÂÜçÂÖ≥Èó≠:
 108   1          P23 = 1;
 109   1          delay_ms(1000);
 110   1          P23 = 0;
 111   1      
 112   1      #if 0  // ÊµãËØïÂèëÈÄÅÊó•ÊúüÂíåÊó∂Èó¥
C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 3   

                  // ÂΩìÂâçÊó•Êúü
                  fun_info.aip1302_saveinfo.year = 2024;
                  fun_info.aip1302_saveinfo.month = 12;
                  fun_info.aip1302_saveinfo.day = 05;
              
                  // ÂΩìÂâçÊó∂Èó¥
                  fun_info.aip1302_saveinfo.time_hour = 13;
                  fun_info.aip1302_saveinfo.time_min = 45;
                  fun_info.aip1302_saveinfo.time_sec = 32;
              
                  aip1302_update_all_data(fun_info.aip1302_saveinfo);
              
                  printf("year %u month %bu day %bu \n", fun_info.aip1302_saveinfo.year, fun_info.aip1302_saveinfo.month
             -, fun_info.aip1302_saveinfo.day);
                  printf("hour %bu min %bu sec %bu \n", fun_info.aip1302_saveinfo.time_hour, fun_info.aip1302_saveinfo.t
             -ime_min, fun_info.aip1302_saveinfo.time_sec);
              #endif // ÊµãËØïÂèëÈÄÅÊó•ÊúüÂíåÊó∂Èó¥
 128   1      
 129   1          printf("sys reset\n");
 130   1      
 131   1          // ÊµãËØïÁ®ãÂ∫èÔºö
 132   1          // fun_info.save_info.total_mileage = (u32)999970 * 1000;
 133   1          // // fun_info.save_info.subtotal_mileage = (u32)999970 * 100;
 134   1          // fun_info.save_info.subtotal_mileage = (u32)99997 * 100;
 135   1          // // fun_info.save_info.subtotal_mileage = (u32)10051 * 100;
 136   1          // fun_info.save_info.subtotal_mileage_2 = (u32)999970 * 100;
 137   1      
 138   1          /* Á≥ªÁªü‰∏ªÂæ™ÁéØ */
 139   1          while (1)
 140   1          {
 141   2              // printf("main circle\n");
 142   2      
 143   2      #if 1
 144   2              WDT_KEY = WDT_KEY_VAL(0xAA); // ÂñÇÁãóÂπ∂Ê∏ÖÈô§ wdt_pending
 145   2      
 146   2      #if TOUCH_KEY_ENABLE
                      /* ÊåâÈîÆÊâ´ÊèèÂáΩÊï∞ */
                      __tk_scan();                 // ‰ΩøÁî®‰∫ÜÂ∫ìÈáåÈù¢ÁöÑÊé•Âè£ÔºàÈó≠Ê∫êÂ∫ìÔºâ
                      WDT_KEY = WDT_KEY_VAL(0xAA); // ÂñÇÁãóÂπ∂Ê∏ÖÈô§ wdt_pending
              #endif
 151   2      
 152   2      #if AD_KEY_ENABLE
                      key_driver_scan(&ad_key_para);
                      ad_key_handle(); // adÊåâÈîÆÂ§ÑÁêÜÂáΩÊï∞
              #endif                   //  #if AD_KEY_ENABLE
 156   2      
 157   2      #if TOUCH_KEY_ENABLE
                      key_driver_scan(&touch_key_para);
                      touch_key_handle(); // Ëß¶Êë∏ÊåâÈîÆÂ§ÑÁêÜÂáΩÊï∞
              #endif
 161   2      #if PIN_LEVEL_SCAN_ENABLE
                      pin_level_scan();
              #endif
 164   2      #if SPEED_SCAN_ENABLE
 165   2      
 166   2              speed_scan();      // Ê£ÄÊµãÊó∂ÈÄü
 167   2              speed_send_data(); // ÂèëÈÄÅÊó∂ÈÄüÊï∞ÊçÆÔºåÈúÄË¶ÅÊó∂Èó¥Âà∞Êù•Êâç‰ºöÊâßË°å
 168   2      
 169   2      #if 0 // Ë∞ÉËØï‰ΩøÁî®
                      if (flag_debug_is_send_time)
                      {
                          if (flag_get_speed == 0) // Á≠âÂæÖ‰∏ä‰∏ÄÊ¨°ÂèëÈÄÅÂÆåÊàê
C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 4   

                          {
                              static u16 tmp = 0;
                              tmp += 10;
                              if (tmp >= 170)
                              {
                                  tmp = 0;
                              }
              
                              fun_info.speed = tmp;
                              // fun_info.speed = 140;
                              flag_get_speed = 1;
              
                              flag_debug_is_send_time = 0;
                          }
                      }
              #endif
 189   2      
 190   2      #endif // #if SPEED_SCAN_ENABLE
 191   2      
 192   2      #if ENGINE_SPEED_SCAN_ENABLE
                      engine_speed_scan();      // Ê£ÄÊµãÂèëÂä®Êú∫ËΩ¨ÈÄü
                      engine_speed_send_data(); // ÂèëÂä®ÂèëÂä®Êú∫ËΩ¨ÈÄüÊï∞ÊçÆÔºåÈúÄË¶ÅÊó∂Èó¥Âà∞Êù•Êâç‰ºöÊâßË°å
              
              #if 0 // Ë∞ÉËØï‰ΩøÁî®
                      if (flag_debug_is_send_time_2)
                      {
                          if (flag_get_engine_speed == 0) // Á≠âÂæÖ‰∏ä‰∏ÄÊ¨°ÂèëÈÄÅÂÆåÊàê
                          {
                              static u32 tmp = 0;
                              tmp += 100;
                              if (tmp >= 13000)
                              {
                                  tmp = 0;
                              }
              
                              fun_info.engine_speeed = tmp;
                              // fun_info.speed = 140;
                              flag_get_engine_speed = 1;
              
                              flag_debug_is_send_time_2 = 0;
                          }
                      }
              #endif
              
              #endif // #if ENGINE_SPEED_SCAN_ENABLE
 218   2      
 219   2              mileage_scan(); // Ê£ÄÊµãÂ§ßËÆ°ÈáåÁ®ãÂíåÂ∞èËÆ°ÈáåÁ®ã
 220   2      
 221   2      #if FUEL_CAPACITY_SCAN_ENABLE
                      fuel_capacity_scan(); // Ê≤πÈáèÊ£ÄÊµã
              #endif                        // FUEL_CAPACITY_SCAN_ENABLE
 224   2      #if BATTERY_SCAN_ENABLE
                      battery_scan(); // ÁîµÊ±†ÁîµÈáèÊ£ÄÊµã
              #endif                  // BATTERY_SCAN_ENABLE
 227   2      
 228   2      #if 0
                      // DEBUG
                      if (flag_is_debug_update)
                      {
                          flag_is_debug_update = 0;
              
                          // fun_info.fuel++;
C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 5   

                          // if (fun_info.fuel > 100)
                          // {
                          //     fun_info.fuel = 0;
                          // }
              
                          // {
                          //     static u16 cnt = 0;
                          //     if (cnt < 4095 - 100)
                          //     {
                          //         cnt += 100;
                          //         fuel_adc_val = cnt;
                          //     }
                          //     else
                          //     {
                          //         cnt = 0;
                          //         fuel_adc_val = cnt;
                          //     }
              
                          //     // flag_get_fuel = 1;
                          // }
              
                          fun_info.save_info.total_mileage += 1000;
                          flag_get_total_mileage = 1;
              
                          fun_info.save_info.subtotal_mileage += 1000;
                          flag_get_sub_total_mileage = 1;
              
                          fun_info.save_info.subtotal_mileage_2 += 1000;
                          flag_get_sub_total_mileage_2 = 1;
              
                          fun_info.engine_speeed += 100;
                          flag_get_engine_speed = 1;
              
                          {
                              static u8 cnt = 0;
              
                              fun_info.speed = cnt;
                              cnt++;
                              if (cnt >= 255)
                              {
                                  cnt = 0;
                              }
              
                              flag_get_speed = 1;
                          } 
              
                          {
                              static u8 fuel_percent = 0;
              
                              /*
                                  ËÆ∞ÂΩï‰∏ä‰∏ÄÊ¨°ÈááÈõÜÂà∞ÁöÑÊ≤πÈáèÊå°‰Ωç
                                  Áî®‰∫éÊéßÂà∂ÊØèÈöî 40s Êõ¥Êñ∞‰∏ÄÊ¨°Ê≤πÈáèÁöÑÊ†ºÊï∞Ôºå0~6Ê†ºÊ≤πÈáè
                              */
                              static u8 fuel_gear = 0;
              
                              if (fuel_capacity_scan_cnt >= 40000)
                              // if (fuel_capacity_scan_cnt >= 4000)
                              {
                                  u8 cur_fuel_gear = 0;
                                  u8 i;
                                  // Â¶ÇÊûúÂà∞‰∫ÜÊâ´ÊèèÊõ¥Êñ∞Êó∂Èó¥
                                  fuel_capacity_scan_cnt = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 6   

              
                                  fuel_gear++;
                                  if (fuel_gear > 6)
                                  {
                                      fuel_gear = 0;
                                  }
              
                                  for (i = 0; i < 255; i++)
                                  {
                                      extern u8 convert_fuel_percent_to_gear(u8 fuel_percent); 
                                      u8 tmp = convert_fuel_percent_to_gear(i);
                                      if (tmp == fuel_gear)
                                      {
                                          fuel_percent = i; // ÂæóÂà∞ÂèòÂåñ‰∏Ä‰∏™Êå°‰ΩçÂêéÂØπÂ∫îÁöÑÊ≤πÈáèÁôæÂàÜÊØî
                                          break;
                                      }
                                  }
              
                              } //  if (fuel_capacity_scan_cnt >= FUEL_UPDATE_TIME)
              
                              fun_info.fuel = fuel_percent;
                              flag_get_fuel = 1; // ÂèëÈÄÅÊ≤πÈáèÁôæÂàÜÊØîÊï∞ÊçÆ
                          }
                      }
              #endif
 322   2      
 323   2              uart0_scan_handle();  // Ê£ÄÊü•‰∏≤Âè£Êé•Êî∂ÁºìÂÜ≤Âå∫ÁöÑÊï∞ÊçÆÊòØÂê¶Á¨¶ÂêàÂçèËÆÆ,Â¶ÇÊûúÊúâÊ≠£Á°ÆÁöÑ
             -Êåá‰ª§Ôºå‰ºöÂ≠òÂà∞Âè¶‰∏Ä‰∏™ÁºìÂÜ≤Âå∫‰∏≠ÔºàÊé•‰∏ãÊù•ËÆ©instruction_scan()ÂáΩÊï∞Êù•Â§ÑÁêÜÔºâ
 324   2              instruction_scan();   // Êâ´ÊèèÊòØÂê¶ÊúâÂêàÊ≥ïÁöÑÊåá‰ª§
 325   2              instruction_handle(); // Êâ´ÊèèÊòØÂê¶ÊúâÂØπÂ∫îÁöÑËé∑Âèñ/Áä∂ÊÄÅÊõ¥Êñ∞Êìç‰Ωú(ÊúÄÂç†Áî®Êó∂Èó¥,Âõ†‰∏∫Ë
             -¶ÅÁ≠âÂæÖ‰∏≤Âè£ÁöÑÊï∞ÊçÆÂèëÈÄÅÂÆåÊàê)
 326   2      
 327   2              if (flag_debug_is_send_time)
 328   2              {
 329   3                  flag_debug_is_send_time = 0;
 330   3                  eeprom_printf_all();
 331   3              }
 332   2      
 333   2      #endif //
 334   2      
 335   2              // aip1302_test();
 336   2              // {
 337   2              //     u8 ret = 0;
 338   2              //     ret = aip1302_is_running();
 339   2              //     if (ret)
 340   2              //     {
 341   2              //         // Â¶ÇÊûúÊó∂ÈíüËäØÁâáaip1302ÁöÑÊô∂ÊåØÊ≠£Âú®ËøêË°å
 342   2              //         printf("aip1302 is running\n");
 343   2              //     }
 344   2              //     else
 345   2              //     {
 346   2              //         // Â¶ÇÊûúÊó∂ÈíüËäØÁâáaip1302ÁöÑÊô∂ÊåØ‰∏çÂú®ËøêË°å
 347   2              //         printf("aip1302 is sleep\n");
 348   2              //     }
 349   2              // }
 350   2      
 351   2              // AIP1302_CE_PIN = 1;
 352   2              // delay_ms(500);
 353   2              // AIP1302_CE_PIN = 0;
 354   2              // delay_ms(500);
 355   2      
 356   2      #if 0
C51 COMPILER V9.60.7.0   MAIN                                                              08/05/2025 17:55:48 PAGE 7   

                      if (flag_debug_is_send_time)
                      {
                          flag_debug_is_send_time = 0;
                          aip1302_read_all();
                          printf("year %u \n", fun_info.aip1302_saveinfo.year);
                          printf("month %bu \n", fun_info.aip1302_saveinfo.month);
                          printf("day %bu \n", fun_info.aip1302_saveinfo.day);
                          printf("hour %bu \n", fun_info.aip1302_saveinfo.time_hour);
                          printf("min %bu \n", fun_info.aip1302_saveinfo.time_min);
                          printf("sec %bu \n", fun_info.aip1302_saveinfo.time_sec);
                      }
              #endif
 369   2      
 370   2              // heart_beat_handle(); //
 371   2      
 372   2              WDT_KEY = WDT_KEY_VAL(0xAA); // ÂñÇÁãóÂπ∂Ê∏ÖÈô§ wdt_pending
 373   2          }
 374   1      }
 375          
 376          /**
 377           * @}
 378           */
 379          
 380          /*************************** (C) COPYRIGHT 2022 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    113    ----
   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
