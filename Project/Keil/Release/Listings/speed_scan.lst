C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE SPEED_SCAN
OBJECT MODULE PLACED IN .\Release\Objects\speed_scan.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\speed_scan.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X
                    -000C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Re
                    -lease\Listings\speed_scan.lst) OBJECT(.\Release\Objects\speed_scan.obj)

line level    source

   1          #include "speed_scan.h"
   2          
   3          #if SPEED_SCAN_ENABLE
   4          
   5          #if 0
              // æ ‡å¿—ä½ï¼Œæ˜¯å¦ç”±æ›´æ–°è®¡æ•°,ç”±å®šæ—¶å™¨æ¥ç½®ä½
              // 0--æœªæ›´æ–°è„‰å†²è®¡æ•°ï¼Œ1--æœ‰æ–°çš„è„‰å†²è®¡æ•°
              volatile bit flag_is_update_speed_pulse_cnt = 0;
              volatile u16 speed_scan_time_cnt = 0;        // é€Ÿåº¦æ‰«ææ—¶ï¼Œç”¨åˆ°çš„æ—¶é—´è®¡æ•°å€¼ï¼Œä¼šåœ¨å®šæ—¶å
             -™¨ä¸­æ–­ä¸­ç´¯åŠ 
              volatile u16 speed_actual_scan_time_cnt = 0; // å­˜æ”¾å®é™…çš„é€Ÿåº¦æ‰«ææ—¶é—´(å®é™…çš„é€Ÿåº¦æ‰«æç”¨
             -æ—¶)
              // volatile u32 detect_speed_pulse_cnt = 0; // æ£€æµ‹æ—¶é€Ÿçš„è„‰å†²è®¡æ•°å€¼(ç”¨IOä¸­æ–­æ¥æ£€æµ‹)
              /*
                  å­˜æ”¾ æ£€æµ‹åˆ°çš„æ—¶é€Ÿè„‰å†²è®¡æ•°å€¼ï¼Œä¼šåœ¨ä¸­æ–­å†…ç´¯åŠ 
                  ä½¿ç”¨äº†åŒç¼“å†²ï¼Œ[0]ç”¨åœ¨å®šæ—¶å™¨ä¸­æ–­ä¸­ï¼Œ[1]ç”¨åœ¨å¤„ç†å‡½æ•°ä¸­
                  å½“ flag_is_update_speed_pulse_cnt == 1æ—¶ï¼Œè¯´æ˜å·²ç»æœ‰æ•°æ®æ›´æ–°
              */
              volatile u32 detect_speed_pulse_cnt[2] = {0}; // æ£€æµ‹æ—¶é€Ÿçš„è„‰å†²è®¡æ•°å€¼
              #endif
  19          
  20          // æ—¶é€Ÿæ‰«æçš„é…ç½®
  21          void speed_scan_config(void)
  22          {
  23   1      #if 1 // ä½¿ç”¨å®šæ—¶å™¨æ‰«æIOç”µå¹³å˜åŒ–æ¥è®¡ç®—è„‰å†²
  24   1      
  25   1          P1_MD1 &= ~GPIO_P15_MODE_SEL(0x3); // è¾“å…¥æ¨¡å¼
  26   1          P1_PU |= GPIO_P15_PULL_UP(0x1);    // é…ç½®ä¸ºä¸Šæ‹‰
  27   1      
  28   1      #endif // ä½¿ç”¨å®šæ—¶å™¨æ‰«æIOç”µå¹³å˜åŒ–æ¥è®¡ç®—è„‰å†²
  29   1      }
  30          
  31          /*
  32              é‡‡ç”¨å®šæ—¶æ£€æµ‹è„‰å†²çš„æ–¹å¼æ¥æ£€æµ‹é€Ÿåº¦ï¼Œä½†æ˜¯æ¯æ®µæ—¶é—´å†…ä¼šå…ˆè®¡ç®—é€Ÿåº¦ï¼Œæœ€åå†
             -æ±‚å¹³å‡å€¼ï¼Œä¼šæœ‰1~2km/hçš„è¯¯å·®
  33          */
  34          #if 0 
              // é€Ÿåº¦æ‰«æå‡½æ•°
              void speed_scan(void)
              {
                  volatile u32 cur_speed = 0;                    // è®°å½•å½“å‰é‡‡é›†åˆ°çš„é€Ÿåº¦
                  static volatile u32 cur_speed_average_val = 0; // å­˜æ”¾å½“å‰é€Ÿåº¦çš„å¹³å‡å€¼(å•ä½ï¼škm/h)
                  static volatile u32 cur_speed_actual_scan_time_cnt = 0; // å­˜æ”¾å½“å‰ é€Ÿåº¦æ‰«ææ—¶é—´
              
                  static volatile u8 speed_scan_cnt = 0;
              
                  if (flag_is_update_speed_pulse_cnt) // å¦‚æœæœ‰æ•°æ®æ›´æ–°
                  {
                      flag_is_update_speed_pulse_cnt = 0;
                      /*
                          è®¡ç®— xx mså†…èµ°è¿‡äº†å¤šå°‘æ¯«ç±³
                          xx mså†…èµ°è¿‡äº†å¤šå°‘æ¯«ç±³ == å½“å‰æ‰«ææ—¶é—´å†…æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•° / è½¦è½®ä¸€åœˆå
             -¯¹åº”å¤šå°‘ä¸ªè„‰å†² * ä¸€åœˆå¯¹åº” xx æ¯«ç±³
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 2   

                          æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
                          xx mså†…èµ°è¿‡äº†å¤šå°‘æ¯«ç±³ == å½“å‰æ‰«ææ—¶é—´å†…æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•° * ä¸€åœˆå¯¹åº” 
             -xx æ¯«ç±³ / è½¦è½®ä¸€åœˆå¯¹åº”å¤šå°‘ä¸ªè„‰å†²
                      */
                      cur_speed = detect_speed_pulse_cnt[1] * SPEED_SCAN_MM_PER_TURN / SPEED_SCAN_PULSE_PER_TURN;
              
                      // printf("cur pulse cnt %lu \n", detect_speed_pulse_cnt[1]); // ä¸´æ—¶æµ‹è¯•ç”¨
              
                      detect_speed_pulse_cnt[1] = 0; // æ¸…ç©ºè„‰å†²è®¡æ•°
                      distance += cur_speed;         // å­˜æ”¾èµ°è¿‡çš„è·ç¦»ï¼Œå•ä½ï¼šæ¯«ç±³
              
                      /*
                          å·²çŸ¥åœ¨æ‰«ææ—¶é—´å†…èµ°è¿‡äº†xx mm
                          æ—¶é€Ÿçš„è®¡ç®—å…¬å¼:
                          æ‰«ææ—¶é—´å†…èµ°è¿‡çš„è·ç¦» / 1000 * (1 / æ‰«ææ—¶é—´å¯¹1sçš„å æ¯”) * 3.6
                              æ‰«ææ—¶é—´å†…èµ°è¿‡çš„è·ç¦» / 1000ï¼Œè½¬æ¢æˆ m/æ‰«ææ—¶é—´ çš„å•ä½
                              * (1 / æ‰«ææ—¶é—´å¯¹1sçš„å æ¯”)ï¼Œè½¬æ¢æˆä»¥sä¸ºå•ä½çš„é€Ÿåº¦
                              * 3.6ï¼Œå› ä¸º 1m/s == 3.6km/hï¼Œæœ€åè½¬æ¢æˆ ä»¥km/hçš„å•ä½
                          è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
                          æ—¶é€Ÿ == æ‰«ææ—¶é—´å†…èµ°è¿‡çš„è·ç¦» * 36 * (1 / æ‰«ææ—¶é—´å¯¹1sçš„å æ¯”) / 10000ï¼›
              
                          é€æ¸å˜æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
                          cur_speed = cur_speed * 36 * (1 / (SPEED_SCAN_TIME_MS / 1000)) / 10000;
                          cur_speed = cur_speed * 36 * 1000 / SPEED_SCAN_TIME_MS / 10000;
                          cur_speed = cur_speed * 36 / SPEED_SCAN_TIME_MS / 10;
                      */
                      // cur_speed = (cur_speed * 36) / speed_actual_scan_time_cnt / 10;
              
                      // printf("cur speed %lu \n", cur_speed);
              
                      if (speed_scan_cnt < SPEED_SCAN_FILTER_CNT)
                      {
                          // å¦‚æœæœªè¾¾åˆ°é‡å¤æ£€æµ‹çš„æ¬¡æ•°
                          speed_scan_cnt++;
                          cur_speed_average_val += cur_speed ; // ç´¯åŠ å½“å‰å¾—åˆ°çš„æ—¶é€Ÿ(å•ä½ï¼škm/h)
                          cur_speed_actual_scan_time_cnt += speed_actual_scan_time_cnt ; // ç´¯åŠ å½“å‰
              
                          // if (cur_speed)
                          // {
                          //     printf("ori speed %lu\n", cur_speed);
                          // }
                      }
                      else
                      {
                          // å¦‚æœè¾¾åˆ°äº†é‡å¤æ£€æµ‹çš„æ¬¡æ•°
                          speed_scan_cnt = 0;
                          cur_speed_average_val = (cur_speed_average_val * 36) / cur_speed_actual_scan_time_cnt / 10 ;
                          // cur_speed_average_val /= SPEED_SCAN_FILTER_CNT; // æ—¶é€Ÿå–å¹³å‡å€¼
                          fun_info.speed = cur_speed_average_val;         // å­˜æ”¾å¾—åˆ°çš„æ—¶é€Ÿ
                          cur_speed_average_val = 0;                      // æ¸…ç©ºå˜é‡çš„å€¼
                          cur_speed_actual_scan_time_cnt = 0;
                          
              
                          // printf("cur speed %lu km/h\n", fun_info.speed);
              #if USE_MY_DEBUG
              
                          if (fun_info.speed != 0)
                          {
                              printf("cur speed %lu km/h\n", fun_info.speed);
                          }
              
              #endif
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 3   

              
                          // é™åˆ¶è¦å‘é€çš„æ—¶é€Ÿ:
                          if (fun_info.speed > 999)
                          {
                              fun_info.speed = 999;
                          }
              
                          flag_get_speed = 1; //
                      }
                  }
              }
              #endif
 123          
 124          #if 0
              // é€Ÿåº¦æ‰«æå‡½æ•°
              void speed_scan(void)
              {
                  volatile u32 cur_speed_pulse_cnt = 0;                   // è®°å½•å½“å‰é‡‡é›†åˆ°çš„é€Ÿåº¦
                  static volatile u32 cur_speed_average_val = 0;          // å­˜æ”¾å½“å‰é€Ÿåº¦çš„å¹³å‡å€¼(å•ä½ï¼škm/
             -h)
                  static volatile u32 cur_speed_actual_scan_time_cnt = 0; // å­˜æ”¾å½“å‰ é€Ÿåº¦æ‰«ææ—¶é—´
              
                  static volatile u8 speed_scan_cnt = 0;
              
                  if (flag_is_update_speed_pulse_cnt) // å¦‚æœæœ‰æ•°æ®æ›´æ–°
                  {
                      flag_is_update_speed_pulse_cnt = 0;
                      /*
                          è®¡ç®— xx mså†…èµ°è¿‡äº†å¤šå°‘æ¯«ç±³
                          xx mså†…èµ°è¿‡äº†å¤šå°‘æ¯«ç±³ == å½“å‰æ‰«ææ—¶é—´å†…æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•° / è½¦è½®ä¸€åœˆå
             -¯¹åº”å¤šå°‘ä¸ªè„‰å†² * ä¸€åœˆå¯¹åº” xx æ¯«ç±³
                          æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
                          xx mså†…èµ°è¿‡äº†å¤šå°‘æ¯«ç±³ == å½“å‰æ‰«ææ—¶é—´å†…æ£€æµ‹åˆ°çš„è„‰å†²ä¸ªæ•° * ä¸€åœˆå¯¹åº” 
             -xx æ¯«ç±³ / è½¦è½®ä¸€åœˆå¯¹åº”å¤šå°‘ä¸ªè„‰å†²
                      */
                      // cur_speed_pulse_cnt = detect_speed_pulse_cnt[1] * SPEED_SCAN_MM_PER_TURN / SPEED_SCAN_PULSE_PER
             -_TURN;
                      cur_speed_pulse_cnt = detect_speed_pulse_cnt[1]; // å¾—åˆ°ä¸€æ®µæ—¶é—´å†…é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•°
              
                      distance += detect_speed_pulse_cnt[1] * SPEED_SCAN_MM_PER_TURN / SPEED_SCAN_PULSE_PER_TURN; // å­˜
             -æ”¾èµ°è¿‡çš„è·ç¦»ï¼Œå•ä½ï¼šæ¯«ç±³
                      detect_speed_pulse_cnt[1] = 0;                                                              // æ¸…
             -ç©ºè„‰å†²è®¡æ•°
              
                      if (speed_scan_cnt < SPEED_SCAN_FILTER_CNT)
                      {
                          // å¦‚æœæœªè¾¾åˆ°é‡å¤æ£€æµ‹çš„æ¬¡æ•°
                          speed_scan_cnt++;
                          cur_speed_average_val += cur_speed_pulse_cnt;                 // ç´¯åŠ å½“å‰å¾—åˆ°çš„è„‰å†²ä¸
             -ªæ•°
                          cur_speed_actual_scan_time_cnt += speed_actual_scan_time_cnt; // ç´¯åŠ å½“å‰æ‰«æé€Ÿåº¦æ‰€ç”
             -¨çš„æ—¶é—´
                      }
                      else
                      {
                          // å¦‚æœè¾¾åˆ°äº†é‡å¤æ£€æµ‹çš„æ¬¡æ•°
                          speed_scan_cnt = 0;
              
                          /*
                              å·²çŸ¥åœ¨æ‰«ææ—¶é—´å†…èµ°è¿‡äº†xx mm
                              æ—¶é€Ÿçš„è®¡ç®—å…¬å¼:
                              æ‰«ææ—¶é—´å†…èµ°è¿‡çš„è·ç¦» / 1000 * (1 / æ‰«ææ—¶é—´å¯¹1sçš„å æ¯”) * 3.6
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 4   

                                  æ‰«ææ—¶é—´å†…èµ°è¿‡çš„è·ç¦» / 1000ï¼Œè½¬æ¢æˆ m/æ‰«ææ—¶é—´ çš„å•ä½
                                  * (1 / æ‰«ææ—¶é—´å¯¹1sçš„å æ¯”)ï¼Œè½¬æ¢æˆä»¥sä¸ºå•ä½çš„é€Ÿåº¦
                                  * 3.6ï¼Œå› ä¸º 1m/s == 3.6km/hï¼Œæœ€åè½¬æ¢æˆ ä»¥km/hçš„å•ä½
                              è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
                              æ—¶é€Ÿ == æ‰«ææ—¶é—´å†…èµ°è¿‡çš„è·ç¦» * 36 * (1 / æ‰«ææ—¶é—´å¯¹1sçš„å æ¯”) / 10000ï¼
             -›
              
                              é€æ¸å˜æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
                          */
                          cur_speed_average_val = (cur_speed_average_val * 36 * SPEED_SCAN_MM_PER_TURN / SPEED_SCAN_PULS
             -E_PER_TURN) / 10 / cur_speed_actual_scan_time_cnt;
                          // cur_speed_average_val /= SPEED_SCAN_FILTER_CNT; // æ—¶é€Ÿå–å¹³å‡å€¼
                          fun_info.speed = cur_speed_average_val; // å­˜æ”¾å¾—åˆ°çš„æ—¶é€Ÿ
                          cur_speed_average_val = 0;              // æ¸…ç©ºå˜é‡çš„å€¼
                          cur_speed_actual_scan_time_cnt = 0;
              
                          printf("cur speed %lu km/h\n", fun_info.speed);
              #if USE_MY_DEBUG
              
                          if (fun_info.speed != 0)
                          {
                              printf("cur speed %lu km/h\n", fun_info.speed);
                          }
              
              #endif
              
                          // é™åˆ¶è¦å‘é€çš„æ—¶é€Ÿ:
                          if (fun_info.speed > 999)
                          {
                              fun_info.speed = 999;
                          }
              
                          flag_get_speed = 1; //
                      }
                  }
              }
              #endif
 200          
 201          static volatile u8 speed_buff[SPEED_SCAN_BUFF_SIZE] = {0};
 202          static volatile u8 cur_send_speed_buff_index = 0;
 203          volatile bit flag_is_send_speed_time_come = 0; // æ ‡å¿—ä½ï¼Œå‘é€é€Ÿåº¦çš„æ—¶é—´åˆ°æ¥
 204          
 205          volatile bit flag_is_speed_scan_over_time = 0; // é€Ÿåº¦æ£€æµ‹æ˜¯å¦ä¸€ç›´æ²¡æœ‰è„‰å†²åˆ°æ¥ï¼Œå¯¼è‡´è¶…æ—
             -¶
 206          volatile u32 speed_pulse_cnt = 0;              // è®°å½•è„‰å†²ä¸ªæ•°ï¼Œåœ¨å®šæ—¶å™¨ä¸­æ–­ç´¯åŠ 
 207          volatile u32 speed_scan_time_ms = 0;           // è®°å½•æ‰«ææ—¶é—´
 208          static volatile u32 cur_speed_scan_time = 0;
 209          static volatile u32 cur_speed_scan_pulse = 0;
 210          
 211          void update_speed_scan_data(void) // æ›´æ–°æ£€æµ‹æ—¶é€Ÿçš„æ•°æ®
 212          {
 213   1          cur_speed_scan_time += speed_scan_time_ms;
 214   1          speed_scan_time_ms = 0;
 215   1          cur_speed_scan_pulse += speed_pulse_cnt;
 216   1          speed_pulse_cnt = 0;
 217   1      }
 218          
 219          void speed_scan(void)
 220          {
 221   1          volatile u16 cur_speed = 0;
 222   1          u32 tmp = 0;
 223   1      
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 5   

 224   1          if (cur_speed_scan_time >= SPEED_SCAN_UPDATE_TIME || flag_is_speed_scan_over_time)
 225   1          {
 226   2              /*
 227   2                  é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•° / ä¸€åœˆå¯¹åº”çš„è„‰å†²ä¸ªæ•° * è½¦è½®ä¸€åœˆå¯¹åº”èµ°è¿‡çš„è·ç¦»ï¼ˆå
             -•ä½ï¼šmmï¼‰ï¼Œ
 228   2                  è®¡ç®—å¾—åˆ° é‡‡é›†çš„è„‰å†²ä¸ªæ•°å¯¹åº”èµ°è¿‡çš„è·ç¦»ï¼ˆå•ä½ï¼šmmï¼‰
 229   2              */
 230   2              // u32 tmp = (cur_speed_scan_pulse * SPEED_SCAN_MM_PER_TURN / SPEED_SCAN_PULSE_PER_TURN);
 231   2              tmp = (((u32)cur_speed_scan_pulse * SPEED_SCAN_MM_PER_TURN) / SPEED_SCAN_PULSE_PER_TURN);
 232   2              // printf("cur_speed_scan_pulse %lu\n", cur_speed_scan_pulse);
 233   2      
 234   2              if (flag_is_speed_scan_over_time) // è¶…æ—¶ï¼Œé‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•°å¯¹åº”ä¸€ç›´æ˜¯0km/hï¼Œè®¤ä¸
             -ºæ—¶é€Ÿæ˜¯0
 235   2              {
 236   3                  cur_speed = 0;
 237   3              }
 238   2              else // æœªè¶…æ—¶ï¼Œè®¡ç®—é‡‡é›†åˆ°çš„è„‰å†²ä¸ªæ•°å¯¹åº”èµ°è¿‡çš„è·ç¦»ï¼Œå†è½¬æ¢æˆä»¥km/hçš„å
             -•ä½
 239   2              {
 240   3                  /*
 241   3                      é‡‡é›†çš„è„‰å†²ä¸ªæ•°å¯¹åº”èµ°è¿‡çš„è·ç¦»ï¼ˆå•ä½ï¼šmmï¼‰/ é‡‡é›†æ‰€ç”¨çš„æ—¶é—´ï¼ˆå•ä½
             -ï¼šmsï¼‰ == é€Ÿåº¦ï¼ˆå•ä½ï¼šmm/msï¼‰
 242   3                      1mm/ms == 1m/s
 243   3                      å› ä¸º 1mm/ms * 1000 == 1m/ms
 244   3                           1m/ms  / 1000 == 1m/s
 245   3                           å…ˆä¹˜ä»¥1000å†é™¤ä»¥1000ï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå°±å¯ä»¥å»æ‰ï¼Œç›´æ¥åŒ–ç®€ä¸º 1mm/
             -ms == 1m/s
 246   3      
 247   3                      1m/s == 3.6km/hï¼Œé‚£ä¹ˆæ ¹æ®å¾—åˆ°çš„ ä»¥ m/s ä¸ºå•ä½çš„é€Ÿåº¦ï¼Œå…ˆä¹˜ä»¥36å†é™¤ä»¥1
             -0ï¼Œå¾—åˆ°ä»¥km/hä¸ºå•ä½çš„é€Ÿåº¦å€¼
 248   3      
 249   3                      cur_speed == é‡‡é›†çš„è„‰å†²ä¸ªæ•°å¯¹åº”èµ°è¿‡çš„è·ç¦»ï¼ˆå•ä½ï¼šmmï¼‰/ é‡‡é›†æ‰€ç”¨çš„æ
             -—¶é—´ï¼ˆå•ä½ï¼šmsï¼‰* 3.6
 250   3                      æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„æ ¼å¼ï¼š
 251   3                      cur_speed == é‡‡é›†çš„è„‰å†²ä¸ªæ•°å¯¹åº”èµ°è¿‡çš„è·ç¦»ï¼ˆå•ä½ï¼šmmï¼‰ * 36 / 10 / é‡‡é›
             -†æ‰€ç”¨çš„æ—¶é—´ï¼ˆå•ä½ï¼šmsï¼‰
 252   3                  */
 253   3                  cur_speed = (u32)tmp * 36 / 10 / cur_speed_scan_time;
 254   3              }
 255   2      
 256   2              // é˜²æ­¢æ—¶é€Ÿä¸º0æ—¶ï¼ˆæœ‰å¯èƒ½æ˜¯æ¨è½¦ï¼Œè®°å½•ä¸åˆ°é€Ÿåº¦ï¼‰ï¼Œè®°å½•ä¸åˆ°é‡Œç¨‹
 257   2              distance += tmp;
 258   2      
 259   2              // printf("cur distace 2 %lu\n", distance);
 260   2              // printf("cur distace %lu\n", distance);
 261   2              // printf("cur speed %lu km/h\n", cur_speed);
 262   2      
 263   2              cur_speed_scan_pulse = 0;
 264   2              cur_speed_scan_time = 0;
 265   2              flag_is_speed_scan_over_time = 0;
 266   2      
 267   2              // é™åˆ¶è¦å‘é€çš„æ—¶é€Ÿ:
 268   2              if (cur_speed > 999) // 999 km/h
 269   2              {
 270   3                  cur_speed = 999;
 271   3              }
 272   2      
 273   2      #if 0
                      /*
                          æ‰«æå®Œæ—¶é€Ÿå°±å‘é€çš„ç¨‹åºï¼Œåœ¨æ˜¾ç¤ºéƒ¨åˆ†ä¼šæœ‰å¡é¡¿ï¼Œ
                          æ˜¾ç¤ºåšä¸äº†åŠ¨ç”»ï¼Œåªèƒ½å•ç‰‡æœºæ¥è°ƒèŠ‚
                      */
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 6   

                      fun_info.speed = cur_speed;
                      // é™åˆ¶è¦å‘é€çš„æ—¶é€Ÿ:
                      if (fun_info.speed > 999)
                      {
                          fun_info.speed = 999;
                      }
              
                      flag_get_speed = 1; // è¡¨ç¤ºé€Ÿåº¦æœ‰æ•°æ®æ›´æ–°
              #endif
 287   2      
 288   2              speed_buff_update(cur_speed);
 289   2      
 290   2          } // if (cur_speed_scan_time >= 500 || flag_is_speed_scan_over_time)
 291   1      }
 292          
 293          void speed_buff_update(u8 speed)
 294          {
 295   1          static u8 last_speed = 0;    // å­˜æ”¾ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„é€Ÿåº¦
 296   1          u8 speed_difference = 0;     // å­˜æ”¾é€Ÿåº¦çš„å·®å€¼
 297   1          bit dir_of_speed_change = 0; // é€Ÿåº¦å˜åŒ–çš„æ–¹å‘ï¼Œ0--é€Ÿåº¦å˜å°ï¼Œ1--é€Ÿåº¦å˜å¤§
 298   1          u8 i = 0;                    // å¾ªç¯è®¡æ•°å€¼
 299   1      
 300   1          if (speed > last_speed)
 301   1          {
 302   2              // å¦‚æœå½“å‰çš„é€Ÿåº¦ å¤§äº ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„é€Ÿåº¦
 303   2              speed_difference = speed - last_speed;
 304   2              dir_of_speed_change = 1; // è¡¨ç¤ºé€Ÿåº¦å˜å¤§
 305   2          }
 306   1          else if (speed < last_speed)
 307   1          {
 308   2              // å¦‚æœå½“å‰çš„é€Ÿåº¦ å°äº ä¸Šä¸€æ¬¡é‡‡é›†åˆ°çš„é€Ÿåº¦
 309   2              speed_difference = last_speed - speed;
 310   2              dir_of_speed_change = 0; // è¡¨ç¤ºé€Ÿåº¦å˜å°
 311   2          }
 312   1          else
 313   1          {
 314   2              for (i = 0; i < SPEED_SCAN_BUFF_SIZE; i++)
 315   2              {
 316   3                  speed_buff[i] = speed;
 317   3              }
 318   2      
 319   2              // // æ²¡æœ‰å·®å€¼ï¼Œç›´æ¥æ›´æ–°ï¼ˆä¿®å¤æ²¡æœ‰å·®å€¼ä¸”æ•°å€¼ä¸º0æ—¶ï¼Œæ²¡æœ‰å‘é€æ•°æ®çš„é—®é
             -¢˜ï¼‰
 320   2              // fun_info.speed = speed;
 321   2              // flag_get_engine_speed = 1;
 322   2      
 323   2              cur_send_speed_buff_index = 0; // æ¸¸æ ‡å¤ä½
 324   2              return;
 325   2          }
 326   1      
 327   1          if (dir_of_speed_change)
 328   1          {
 329   2              // å¦‚æœé€Ÿåº¦åœ¨å˜å¤§ï¼Œæ•°ç»„ä» [0] ~ [SPEED_SCAN_BUFF_SIZE - 1] æ•°å€¼è¶Šæ¥è¶Šå¤§
 330   2              for (i = 0; i < SPEED_SCAN_BUFF_SIZE; i++)
 331   2              {
 332   3                  speed_buff[i] = speed_difference * (i + 1) / SPEED_SCAN_BUFF_SIZE + last_speed;
 333   3              }
 334   2          }
 335   1          else
 336   1          {
 337   2              // å¦‚æœé€Ÿåº¦åœ¨å˜å°ï¼Œæ•°ç»„ä» [0] ~ [SPEED_SCAN_BUFF_SIZE - 1] æ•°å€¼è¶Šæ¥è¶Šå°
 338   2              for (i = 0; i < SPEED_SCAN_BUFF_SIZE; i++)
C51 COMPILER V9.60.7.0   SPEED_SCAN                                                        08/02/2025 16:49:15 PAGE 7   

 339   2              {
 340   3                  speed_buff[SPEED_SCAN_BUFF_SIZE - 1 - i] = last_speed - (u32)speed_difference * (SPEED_SCAN_BU
             -FF_SIZE - i - 1) / SPEED_SCAN_BUFF_SIZE;
 341   3              }
 342   2          }
 343   1      
 344   1          last_speed = speed;
 345   1          cur_send_speed_buff_index = 0; // æ¸¸æ ‡å¤ä½
 346   1      }
 347          
 348          void speed_send_data(void)
 349          {
 350   1          if (flag_is_send_speed_time_come) // å¦‚æœå‘é€é€Ÿåº¦çš„æ—¶é—´åˆ°æ¥
 351   1          {
 352   2              flag_is_send_speed_time_come = 0;
 353   2      
 354   2              if (cur_send_speed_buff_index >= SPEED_SCAN_BUFF_SIZE)
 355   2              {
 356   3                  // é˜²æ­¢è¶Šç•Œ
 357   3                  return;
 358   3              }
 359   2      
 360   2              fun_info.speed = speed_buff[cur_send_speed_buff_index];
 361   2              cur_send_speed_buff_index++;
 362   2      
 363   2              // printf("fun_info.speed = %lu\n", fun_info.speed);
 364   2              flag_get_speed = 1;
 365   2          }
 366   1      }
 367          
 368          #endif // SPEED_SCAN_ENABLE


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    578    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     25       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
