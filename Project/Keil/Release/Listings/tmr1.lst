C51 COMPILER V9.60.7.0   TMR1                                                              07/31/2025 17:40:03 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TMR1
OBJECT MODULE PLACED IN .\Release\Objects\tmr1.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\tmr1.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X00
                    -0C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Rele
                    -ase\Listings\tmr1.lst) OBJECT(.\Release\Objects\tmr1.obj)

line level    source

   1          #include "tmr1.h"
   2          
   3          // #define TMR1_CNT_TIME 152 // 152 * 0.65625us çº¦ç­‰äº100us
   4          
   5          // å®šæ—¶å™¨å®šæ—¶å‘¨æœŸ (å•ä½:Hz)
   6          // å‘¨æœŸå€¼ = ç³»ç»Ÿæ—¶é’Ÿ / å®šæ—¶å™¨åˆ†é¢‘ / é¢‘ç‡ - 1
   7          #define TMR1_PERIOD (SYSCLK / 128 / 1000 - 1) // 1000Hz,1ms
   8          
   9          // volatile bit tmr1_flag = 0; // TMR1ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šç½®ä½çš„æ ‡å¿—ä½
  10          volatile u32 tmr1_cnt = 0; // å®šæ—¶å™¨TMR1çš„è®¡æ•°å€¼ï¼ˆæ¯æ¬¡åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šåŠ ä¸€ï¼‰
  11          
  12          #if USE_MY_DEBUG
              
              // volatile bit flag_is_printf_time = 0;
              
              #endif
  17          
  18          /**
  19           * @brief é…ç½®å®šæ—¶å™¨TMR1ï¼Œé…ç½®å®Œæˆåï¼Œå®šæ—¶å™¨é»˜è®¤å…³é—­
  20           */
  21          void tmr1_config(void)
  22          {
  23   1          __SetIRQnIP(TMR1_IRQn, TMR1_IQn_CFG); // è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§ï¼ˆTMR1ï¼‰
  24   1          __DisableIRQ(TMR1_IRQn);              // ç¦ç”¨ä¸­æ–­
  25   1          IE_EA = 1;                            // æ‰“å¼€æ€»ä¸­æ–­
  26   1      
  27   1          TMR_ALLCON = TMR1_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
  28   1      
  29   1          TMR1_CONL &= ~TMR_PRESCALE_SEL(0x07); // æ¸…é™¤TMR1çš„é¢„åˆ†é¢‘é…ç½®å¯„å­˜å™¨
  30   1          TMR1_CONL |= TMR_PRESCALE_SEL(0x07);  // å®šæ—¶å™¨é¢„åˆ†é¢‘
  31   1          TMR1_CONL &= ~TMR_MODE_SEL(0x03);     // æ¸…é™¤TMR1çš„æ¨¡å¼é…ç½®å¯„å­˜å™¨
  32   1          TMR1_CONL |= TMR_MODE_SEL(0x01);      // é…ç½®TMR1çš„æ¨¡å¼ä¸ºè®¡æ•°å™¨æ¨¡å¼ï¼Œæœ€åå¯¹ç³»ç»Ÿæ—¶é’Ÿ
             -çš„è„‰å†²è¿›è¡Œè®¡æ•°
  33   1      
  34   1          TMR1_CONH &= ~TMR_PRD_PND(0x01); // æ¸…é™¤TMR1çš„è®¡æ•°æ ‡å¿—ä½ï¼Œè¡¨ç¤ºæœªå®Œæˆè®¡æ•°
  35   1          TMR1_CONH |= TMR_PRD_IRQ_EN(1);  // ä½¿èƒ½TMR1çš„è®¡æ•°ä¸­æ–­
  36   1      
  37   1          // é…ç½®TMR1çš„è®¡æ•°å‘¨æœŸ
  38   1          TMR1_PRH = TMR_PERIOD_VAL_H((TMR1_PERIOD >> 8) & 0xFF); // å‘¨æœŸå€¼
  39   1          TMR1_PRL = TMR_PERIOD_VAL_L((TMR1_PERIOD >> 0) & 0xFF);
  40   1      
  41   1          TMR1_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤TMR1çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  42   1          TMR1_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®TMR1çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
  43   1      }
  44          
  45          /**
  46           * @brief å¼€å¯å®šæ—¶å™¨TMR1ï¼Œå¼€å§‹è®¡æ—¶
  47           */
  48          void tmr1_enable(void)
  49          {
  50   1          // é‡æ–°ç»™TMR1é…ç½®æ—¶é’Ÿ
  51   1          TMR1_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  52   1          TMR1_CONL |= TMR_SOURCE_SEL(0x06);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä½¿ç”¨ç³»ç»Ÿæ—¶é’Ÿ
C51 COMPILER V9.60.7.0   TMR1                                                              07/31/2025 17:40:03 PAGE 2   

  53   1      
  54   1          __EnableIRQ(TMR1_IRQn); // ä½¿èƒ½ä¸­æ–­
  55   1          IE_EA = 1;              // æ‰“å¼€æ€»ä¸­æ–­
  56   1      }
  57          
  58          #if 0  // void tmr1_disable(void)
              /**
               * @brief å…³é—­å®šæ—¶å™¨ï¼Œæ¸…ç©ºè®¡æ•°å€¼
               */
              void tmr1_disable(void)
              {
                  // ä¸ç»™å®šæ—¶å™¨æä¾›æ—¶é’Ÿï¼Œè®©å®ƒåœæ­¢è®¡æ•°
                  TMR1_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
                  TMR1_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
              
                  TMR_ALLCON = TMR1_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
              
                  __DisableIRQ(TMR1_IRQn); // å…³é—­ä¸­æ–­ï¼ˆä¸ä½¿èƒ½ä¸­æ–­ï¼‰
              }
              #endif // void tmr1_disable(void)
  73          
  74          void heart_beat_handle(void)
  75          {
  76   1          static volatile u32 old_time_ms_cnt = 0; //
  77   1          volatile u32 cur_time_ms_cnt = tmr1_cnt; // å…ˆè¯»å‡ºè®¡æ—¶,é˜²æ­¢è¢«ä¸­æ–­æ‰“æ–­
  78   1          volatile u32 diff_ms_cnt = 0;
  79   1          tmr1_cnt = 0;                                    // è¯»å‡ºè®¡æ—¶å,ç«‹åˆ»æ¸…é™¤å®šæ—¶å™¨çš„è®¡æ—¶
  80   1          diff_ms_cnt = cur_time_ms_cnt - old_time_ms_cnt; // è®¡ç®—æ—¶é—´å·®
  81   1          old_time_ms_cnt = 0;
  82   1      
  83   1      #if 0
              
                  // if (engine_scan_time_cnt < 65535 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
                  // {
                  //     // engine_scan_time_cnt++;
                  //     engine_scan_time_cnt += diff_ms_cnt;
                  //     if (engine_scan_time_cnt >= ENGINE_SPEED_SCAN_TIME_MS) // å¦‚æœå·²ç»åˆ°äº†ç´¯è®¡çš„æ—¶é—´
                  //     {
                  //         engine_actual_scan_time_cnt = engine_scan_time_cnt; // æ›´æ–°å®é™…çš„æ‰«ææ£€æµ‹æ—¶é—´
                  //         engine_scan_time_cnt = 0;
                  //         // detect_engine_pulse_cnt[1] += detect_engine_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­
             -æ‰«æåˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
                  //         // ä¸èƒ½åœ¨å®šæ—¶å™¨ä¸­æ–­å†…ç´¯åŠ è„‰å†²è®¡æ•°ï¼Œä¸»å¾ªç¯æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œç›¸å…³çš„è
             -®¡æ•°å‡½æ•°å°±ä¸èƒ½å®šæœŸå–åˆ°è¿™ä¸ªå€¼ï¼Œ
                  //         // ä¼šå½±å“è®¡ç®—ç»“æœï¼Œå¯èƒ½å¤šåŠ äº†å‡ ä¸ªè„‰å†²è®¡æ•°
                  //         // ä¸‹é¢ç›´æ¥è®©æ•°æ®è¦†ç›–ï¼Œå¦‚æœè®¡ç®—å‡½æ•°æ²¡æœ‰åŠæ—¶å–åˆ°æ•°å€¼ï¼Œä¹Ÿä¸å½±å“è
             -®¡ç®—ç»“æœ
                  //         detect_engine_pulse_cnt[1] = detect_engine_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰«æ
             -åˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
                  //         detect_engine_pulse_cnt[0] = 0;
                  //         flag_is_update_engine_pulse_cnt = 1; // è¡¨ç¤ºæœ‰æ•°æ®æ›´æ–°
                  //     }
                  // }
              
                  // if (speed_scan_time_cnt < 65535 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
                  // {
                  //     // speed_scan_time_cnt++;
                  //     speed_scan_time_cnt += diff_ms_cnt;
                  //     if (speed_scan_time_cnt >= SPEED_SCAN_TIME_MS) // å¦‚æœç»è¿‡äº† xx ms
                  //     {
                  //         speed_actual_scan_time_cnt = speed_scan_time_cnt; // æ›´æ–°å®é™…çš„æ‰«ææ£€æµ‹æ—¶é—´
                  //         speed_scan_time_cnt = 0;
C51 COMPILER V9.60.7.0   TMR1                                                              07/31/2025 17:40:03 PAGE 3   

                  //         // detect_speed_pulse_cnt[1] += detect_speed_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰
             -«æåˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
                  //         // ä¸èƒ½åœ¨å®šæ—¶å™¨ä¸­æ–­å†…ç´¯åŠ è„‰å†²è®¡æ•°ï¼Œä¸»å¾ªç¯æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œç›¸å…³çš„è
             -®¡æ•°å‡½æ•°å°±ä¸èƒ½å®šæœŸå–åˆ°è¿™ä¸ªå€¼ï¼Œ
                  //         // ä¼šå½±å“è®¡ç®—ç»“æœï¼Œå¯èƒ½å¤šåŠ äº†å‡ ä¸ªè„‰å†²è®¡æ•°
                  //         // ä¸‹é¢ç›´æ¥è®©æ•°æ®è¦†ç›–ï¼Œå¦‚æœè®¡ç®—å‡½æ•°æ²¡æœ‰åŠæ—¶å–åˆ°æ•°å€¼ï¼Œä¹Ÿä¸å½±å“è
             -®¡ç®—ç»“æœ
                  //         detect_speed_pulse_cnt[1] = detect_speed_pulse_cnt[0]; // å°†å¦ä¸€ä¸ªå®šæ—¶å™¨ä¸­æ–­æ‰«æ
             -åˆ°çš„è„‰å†²æ›´æ–°åˆ°[1]
                  //         detect_speed_pulse_cnt[0] = 0;                         //
                  //         flag_is_update_speed_pulse_cnt = 1;                    // è¡¨ç¤ºæœ‰æ•°æ®æ›´æ–°
                  //     } 
                  // }
              
              #endif
 122   1      
 123   1          if (mileage_save_time_cnt < 4294967295 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
 124   1          {
 125   2              // mileage_save_time_cnt++;
 126   2              mileage_save_time_cnt += diff_ms_cnt;
 127   2          }
 128   1      
 129   1          if (fuel_capacity_scan_cnt < 4294967295 - diff_ms_cnt) // é˜²æ­¢è®¡æ•°æº¢å‡º
 130   1          {
 131   2              // fuel_capacity_scan_cnt++;
 132   2              fuel_capacity_scan_cnt += diff_ms_cnt;
 133   2          }
 134   1      
 135   1          if (synchronous_request_status == SYN_REQUEST_STATUS_HANDLING)
 136   1          {
 137   2              // synchronous_request_time_cnt++; // åŒæ­¥è¯·æ±‚çš„å†·å´è®¡æ—¶
 138   2              synchronous_request_time_cnt += diff_ms_cnt; // åŒæ­¥è¯·æ±‚çš„å†·å´è®¡æ—¶
 139   2              if (synchronous_request_time_cnt >= 2500)
 140   2              {
 141   3                  // å¦‚æœæ¥æ”¶åŒæ­¥è¯·æ±‚å·²ç»è¿‡äº† xx sï¼Œæ¸…é™¤å†·å´çŠ¶æ€
 142   3                  synchronous_request_time_cnt = 0;
 143   3                  synchronous_request_status = SYN_REQUEST_STATUS_NONE;
 144   3              }
 145   2          }
 146   1      
 147   1          if (update_date_status == UPDATE_STATUS_HANDLING)
 148   1          {
 149   2              // å¦‚æœæ›´æ–°æ—¥æœŸè¿›å…¥å†·å´çŠ¶æ€ï¼Œè¿›è¡Œå†·å´è®¡æ—¶
 150   2              // update_date_cooling_cnt++;
 151   2              update_date_cooling_cnt += diff_ms_cnt;
 152   2              if (update_date_cooling_cnt >= 100) // xx ms
 153   2              {
 154   3                  // è¿‡äº†å†·å´æ—¶é—´ï¼Œé€€å‡ºå†·å´çŠ¶æ€
 155   3                  update_date_cooling_cnt = 0;
 156   3                  update_date_status = UPDATE_STATUS_NONE;
 157   3              }
 158   2          }
 159   1      
 160   1          if (update_time_status == UPDATE_STATUS_HANDLING)
 161   1          {
 162   2              // å¦‚æœæ›´æ–°æ—¶é—´è¿›å…¥å†·å´çŠ¶æ€ï¼Œè¿›è¡Œå†·å´è®¡æ—¶
 163   2              // update_time_cooling_cnt++;
 164   2              update_time_cooling_cnt += diff_ms_cnt;
 165   2              if (update_time_cooling_cnt >= 100) // xx ms
 166   2              {
 167   3                  // è¿‡äº†å†·å´æ—¶é—´ï¼Œé€€å‡ºå†·å´çŠ¶æ€
 168   3                  update_time_cooling_cnt = 0;
C51 COMPILER V9.60.7.0   TMR1                                                              07/31/2025 17:40:03 PAGE 4   

 169   3                  update_time_status = UPDATE_STATUS_NONE;
 170   3              }
 171   2          }
 172   1      
 173   1          if (mileage_update_time_cnt < 65535)
 174   1          {
 175   2              mileage_update_time_cnt++;
 176   2          }
 177   1      
 178   1          if (battery_scan_time_cnt < 4294967295)
 179   1          {
 180   2              battery_scan_time_cnt++;
 181   2          }
 182   1      }
 183          
 184          // TMR1ä¸­æ–­æœåŠ¡å‡½æ•°
 185          void TIMR1_IRQHandler(void) interrupt TMR1_IRQn
 186          {
 187   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 188   1          __IRQnIPnPush(TMR1_IRQn);
 189   1      
 190   1          /*
 191   1              æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´
 192   1              å†…éƒ¨æœªè°ƒç”¨å‡½æ•°ï¼Œçº¦           74.5us,
 193   1              è°ƒç”¨engine_speed_scan()æ—¶çº¦ 200us,
 194   1              è°ƒç”¨speed_scan()æ—¶çº¦        271us,
 195   1              ä¸¤ä¸ªä¸€èµ·è°ƒç”¨ï¼Œçº¦             426us,
 196   1      
 197   1              å°† engine_speed_scan()å’Œspeed_scan()æ”¾åˆ°ä¸»å‡½æ•°æ¥è®¡ç®—ï¼Œ
 198   1              æœ€çŸ­ç”¨æ—¶çº¦ 43usï¼Œ
 199   1              ç›¸ç»§æ‰§è¡Œäº†engine_speed_scanå’Œspeed_scanå¯¹åº”çš„æ¡ä»¶ï¼Œè¿›è¡Œæ›´æ–°æ—¶ï¼Œçº¦ 75us
 200   1      
 201   1              å°† å¯¹å…¶ä»–åŠŸèƒ½çš„æ—¶é—´è¿›è¡Œè®¡æ•°çš„æ“ä½œå…¨éƒ¨è½¬ç§»åˆ°å¤–éƒ¨å‡½æ•°,åªåœ¨è¯¥ä¸­æ–­å¯¹ tm
             -r1_cnt åŠ ä¸€,
 202   1              çº¦ 5us
 203   1          */
 204   1          // P20 = 1;
 205   1      
 206   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
 207   1      
 208   1          // å‘¨æœŸä¸­æ–­
 209   1          if (TMR1_CONH & TMR_PRD_PND(0x1))
 210   1          {
 211   2              TMR1_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
 212   2      
 213   2              if (tmr1_cnt < 4294967295)
 214   2              {
 215   3                  tmr1_cnt++;
 216   3              }
 217   2      
 218   2              {
 219   3                  // static u8 cnt = 0;
 220   3                  // cnt++;
 221   3                  // if (cnt >= TOUCH_KEY_SCAN_CIRCLE_TIMES) // xx ms
 222   3                  // {
 223   3                  //     cnt = 0;
 224   3                  //     // flag_is_touch_key_scan_circle_arrived = 1; // è¡¨ç¤ºæ‰«æå‘¨æœŸåˆ°æ¥ï¼Œæ‰§è¡Œä¸€æ¬
             -¡æŒ‰é”®æ‰«æ
 225   3      
 226   3                  //     // {
 227   3                  //     //     static u8 send_cnt = 0;
 228   3                  //     //     send_cnt++;
C51 COMPILER V9.60.7.0   TMR1                                                              07/31/2025 17:40:03 PAGE 5   

 229   3                  //     //     if (send_cnt >= 100)
 230   3                  //     //     {
 231   3                  //     //         send_cnt = 0;
 232   3                  //     //         printf("touch key scan\n");
 233   3                  //     //     }
 234   3                  //     // }
 235   3                  // }
 236   3      
 237   3      #if AD_KEY_ENABLE
 238   3                  // åœ¨å®šæ—¶å™¨æ³¨å†ŒæŒ‰é”®æ‰«æï¼š
 239   3                  if (ad_key_para.cur_scan_times < 255)
 240   3                  {
 241   4                      ad_key_para.cur_scan_times++;
 242   4                  }
 243   3      #endif // AD_KEY_ENABLE
 244   3      
 245   3      #if TOUCH_KEY_ENABLE
 246   3                  if (touch_key_para.cur_scan_times < 255)
 247   3                  {
 248   4                      touch_key_para.cur_scan_times++;
 249   4                  }
 250   3      #endif // TOUCH_KEY_ENABLE
 251   3      
 252   3                  if (pin_level_scan_time_cnt < 65535) // é˜²æ­¢è®¡æ•°æº¢å‡º
 253   3                  {
 254   4                      pin_level_scan_time_cnt++;
 255   4                  }
 256   3      
 257   3      #if USE_MY_DEBUG
              
                          // {
                          //     static u16 cnt;
                          //     cnt++;
                          //     if (cnt >= 2000)
                          //     {
                          //         cnt = 0;
                          //         flag_is_printf_time = 1;
                          //     }
                          // }
              
              #endif
 270   3      
 271   3                  if (flag_timer_scan_update_fuel_gear)
 272   3                  {
 273   4                      if (timer_scan_update_fuel_gear_cnt < 65535)
 274   4                      {
 275   5                          timer_scan_update_fuel_gear_cnt++;
 276   5                          if (timer_scan_update_fuel_gear_cnt >= FUEL_UPDATE_LAST_FUEL_PERCENTAGE_TIME)
 277   5                          // if (timer_scan_update_fuel_gear_cnt >= 5000) // DEBUG æµ‹è¯•ç”¨
 278   5                          {
 279   6                              timer_scan_update_fuel_gear_cnt = 0;
 280   6                              flag_update_fuel_gear = 1; // æ›´æ–°æ²¹é‡æŒ¡ä½
 281   6                          }
 282   5                      }
 283   4                  }
 284   3                  else
 285   3                  {
 286   4                      timer_scan_update_fuel_gear_cnt = 0;
 287   4                      flag_update_fuel_gear = 0;
 288   4                  }
 289   3      
 290   3      #if 0 // DEBUG åªåœ¨æµ‹è¯•æ—¶ä½¿ç”¨
C51 COMPILER V9.60.7.0   TMR1                                                              07/31/2025 17:40:03 PAGE 6   

              
                          {
                              static u16 cnt;
                              cnt++;
                              if (cnt >= 1000)
                              {
                                  cnt = 0;
                                  flag_is_debug_update = 1;
                              }
                          }
              
              #endif // // DEBUG åªåœ¨æµ‹è¯•æ—¶ä½¿ç”¨
 303   3              }
 304   2          }
 305   1      
 306   1          // P20 = 0;// æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´
 307   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 308   1          __IRQnIPnPop(TMR1_IRQn);
 309   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    620    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8       8
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
