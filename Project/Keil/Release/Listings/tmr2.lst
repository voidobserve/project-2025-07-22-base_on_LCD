C51 COMPILER V9.60.7.0   TMR2                                                              08/02/2025 16:49:13 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TMR2
OBJECT MODULE PLACED IN .\Release\Objects\tmr2.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\tmr2.c LARGE OPTIMIZE(9,SIZE) BROWSE ORDER INTVECTOR(0X00
                    -0C) INCDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.\Rele
                    -ase\Listings\tmr2.lst) OBJECT(.\Release\Objects\tmr2.obj)

line level    source

   1          // å®šæ—¶å™¨TMR2çš„é©±åŠ¨æºæ–‡ä»¶
   2          #include "tmr2.h"
   3          
   4          // å®šæ—¶å™¨å®šæ—¶å‘¨æœŸ (å•ä½:Hz)
   5          // å‘¨æœŸå€¼ = ç³»ç»Ÿæ—¶é’Ÿ / å®šæ—¶å™¨åˆ†é¢‘ / é¢‘ç‡ - 1
   6          #define TMR2_PERIOD (SYSCLK / 1 / 20000 - 1) // 20khzï¼Œ50us
   7          // #define TMR2_PERIOD (SYSCLK / 1 / 10000 - 1) // 10khzï¼Œ100us
   8          
   9          // static volatile u8 tmr2_cnt = 0; // å®šæ—¶å™¨TMR2çš„è®¡æ•°å€¼ï¼ˆæ¯æ¬¡åœ¨ä¸­æ–­æœåŠ¡å‡½æ•°ä¸­ä¼šåŠ ä¸€
             -ï¼‰
  10          
  11          /**
  12           * @brief é…ç½®å®šæ—¶å™¨TMR2ï¼Œé…ç½®å®Œæˆåï¼Œå®šæ—¶å™¨é»˜è®¤å…³é—­
  13           */
  14          void tmr2_config(void)
  15          {
  16   1          __SetIRQnIP(TMR2_IRQn, TMR2_IQn_CFG); // è®¾ç½®ä¸­æ–­ä¼˜å…ˆçº§
  17   1          __DisableIRQ(TMR2_IRQn);              // ç¦ç”¨ä¸­æ–­
  18   1          IE_EA = 1;                            // æ‰“å¼€æ€»ä¸­æ–­
  19   1      
  20   1          // æ¸…é™¤TMR2çš„è®¡æ•°å€¼
  21   1          TMR_ALLCON = TMR2_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
  22   1      
  23   1          TMR2_CONL &= ~TMR_PRESCALE_SEL(0x07); // æ¸…é™¤TMR2çš„é¢„åˆ†é¢‘é…ç½®å¯„å­˜å™¨
  24   1          TMR2_CONL |= TMR_PRESCALE_SEL(0x0);   // å®šæ—¶å™¨é¢„åˆ†é¢‘
  25   1          TMR2_CONL &= ~TMR_MODE_SEL(0x03);     // æ¸…é™¤TMR2çš„æ¨¡å¼é…ç½®å¯„å­˜å™¨
  26   1          TMR2_CONL |= TMR_MODE_SEL(0x01);      // é…ç½®TMR2çš„æ¨¡å¼ä¸ºè®¡æ•°å™¨æ¨¡å¼ï¼Œæœ€åå¯¹ç³»ç»Ÿæ—¶é’Ÿ
             -çš„è„‰å†²è¿›è¡Œè®¡æ•°
  27   1      
  28   1          // é…ç½®TMR2çš„è®¡æ•°å‘¨æœŸ
  29   1          TMR2_PRH = TMR_PERIOD_VAL_H((TMR2_PERIOD >> 8) & 0xFF); // å‘¨æœŸå€¼
  30   1          TMR2_PRL = TMR_PERIOD_VAL_L((TMR2_PERIOD >> 0) & 0xFF);
  31   1      
  32   1          TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤TMR2çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  33   1          TMR2_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®TMR2çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
  34   1          TMR2_CONH &= ~TMR_PRD_PND(0x01);      // æ¸…é™¤TMR2çš„è®¡æ•°æ ‡å¿—ä½ï¼Œè¡¨ç¤ºæœªå®Œæˆè®¡æ•°
  35   1          TMR2_CONH |= TMR_PRD_IRQ_EN(1);       // ä½¿èƒ½TMR2çš„è®¡æ•°ä¸­æ–­
  36   1      }
  37          
  38          /**
  39           * @brief å¼€å¯å®šæ—¶å™¨TMR2ï¼Œå¼€å§‹è®¡æ—¶
  40           */
  41          void tmr2_enable(void)
  42          {
  43   1          // é‡æ–°ç»™TMR2é…ç½®æ—¶é’Ÿ
  44   1          TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
  45   1          TMR2_CONL |= TMR_SOURCE_SEL(0x06);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä½¿ç”¨ç³»ç»Ÿæ—¶é’Ÿ
  46   1      
  47   1          __EnableIRQ(TMR2_IRQn); // ä½¿èƒ½ä¸­æ–­
  48   1          IE_EA = 1;              // æ‰“å¼€æ€»ä¸­æ–­
  49   1      }
  50          
  51          #if 0  // void tmr2_disable(void)
C51 COMPILER V9.60.7.0   TMR2                                                              08/02/2025 16:49:13 PAGE 2   

              /**
               * @brief å…³é—­å®šæ—¶å™¨ï¼Œæ¸…ç©ºè®¡æ•°å€¼
               */
              void tmr2_disable(void)
              {
                  // ä¸ç»™å®šæ—¶å™¨æä¾›æ—¶é’Ÿï¼Œè®©å®ƒåœæ­¢è®¡æ•°
                  TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // æ¸…é™¤å®šæ—¶å™¨çš„æ—¶é’Ÿæºé…ç½®å¯„å­˜å™¨
                  TMR2_CONL |= TMR_SOURCE_SEL(0x05);    // é…ç½®å®šæ—¶å™¨çš„æ—¶é’Ÿæºï¼Œä¸ç”¨ä»»ä½•æ—¶é’Ÿ
              
                  TMR_ALLCON = TMR2_CNT_CLR(0x1); // æ¸…é™¤è®¡æ•°å€¼
              
                  __DisableIRQ(TMR2_IRQn); // å…³é—­ä¸­æ–­ï¼ˆä¸ä½¿èƒ½ä¸­æ–­ï¼‰
              }
              #endif // void tmr2_disable(void)
  66          
  67          extern void update_engine_speed_scan_data(void); // æ›´æ–°æ£€æµ‹å‘åŠ¨æœºè½¬é€Ÿçš„æ•°æ®
  68          #if SPEED_SCAN_ENABLE
  69          extern void update_speed_scan_data(void);
  70          #endif // #if SPEED_SCAN_ENABLE
  71          // TMR2ä¸­æ–­æœåŠ¡å‡½æ•°
  72          void TIMR2_IRQHandler(void) interrupt TMR2_IRQn
  73          {
  74   1      // ä¸Šå‡æ²¿æ£€æµ‹
  75   1      #if ENGINE_SPEED_SCAN_ENABLE
  76   1      
  77   1          static volatile bit last_engine_speed_scan_level = 0; // è®°å½•ä¸Šä¸€æ¬¡æ£€æµ‹åˆ°çš„å¼•è„šç”µå¹³ï¼ˆå‘
             -é€æœºè½¬é€Ÿæ£€æµ‹è„šï¼‰
  78   1      
  79   1      #endif // #if ENGINE_SPEED_SCAN_ENABLE
  80   1      
  81   1      #if SPEED_SCAN_ENABLE
  82   1      
  83   1          static volatile bit last_speed_scan_level = 0; // è®°å½•ä¸Šä¸€æ¬¡æ£€æµ‹åˆ°çš„å¼•è„šç”µå¹³ï¼ˆæ—¶é€Ÿæ£€æ
             -µ‹è„šï¼‰
  84   1      
  85   1      #endif // #if SPEED_SCAN_ENABLE
  86   1      
  87   1          // è¿›å…¥ä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
  88   1          __IRQnIPnPush(TMR2_IRQn);
  89   1          // P20 = 1; // æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´(çº¦3us)
  90   1      
  91   1          // ---------------- ç”¨æˆ·å‡½æ•°å¤„ç† -------------------
  92   1          // å‘¨æœŸä¸­æ–­
  93   1          if (TMR2_CONH & TMR_PRD_PND(0x1))
  94   1          {
  95   2              TMR2_CONH |= TMR_PRD_PND(0x1); // æ¸…é™¤pending
  96   2      
  97   2      #if ENGINE_SPEED_SCAN_ENABLE
  98   2      
  99   2              { // è®°å½•å‘åŠ¨æœºè½¬é€Ÿæ‰«æçš„æ—¶é—´
 100   3                  static u8 cnt = 0;
 101   3                  cnt++;
 102   3                  if (cnt >= 20) // æ¯1msè¿›å…¥ä¸€æ¬¡
 103   3                  {
 104   4                      cnt = 0;
 105   4                      engine_speed_scan_ms++;
 106   4      
 107   4                      if (engine_speed_scan_ms >= ENGINE_SPEED_SCAN_OVER_TIME &&
 108   4                          flag_is_engine_speed_scan_over_time == 0)
 109   4                      {
 110   5                          engine_speed_scan_ms = 0;
 111   5                          flag_is_engine_speed_scan_over_time = 1; // è¯´æ˜è¶…æ—¶ï¼Œè„‰å†²è®¡æ•°ä¸€ç›´æ²¡æœ‰åŠ 
C51 COMPILER V9.60.7.0   TMR2                                                              08/02/2025 16:49:13 PAGE 3   

             -ä¸€
 112   5                      }
 113   4                  }
 114   3              }
 115   2      
 116   2              if (ENGINE_SPEED_SCAN_PIN) // æ£€æµ‹å‘åŠ¨æœºè½¬é€Ÿçš„å¼•è„š
 117   2              {
 118   3                  if (0 == last_engine_speed_scan_level)
 119   3                  {
 120   4                      // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°ä½ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°é«˜ç”µå¹³ï¼Œè¯´æ˜æœ‰ä¸Šå‡æ²¿ï¼Œå¯¹è„‰
             -å†²è®¡æ•°åŠ ä¸€
 121   4                      // if (detect_engine_pulse_cnt[0] < 4294967295) // é˜²æ­¢è®¡æ•°æº¢å‡º
 122   4                      // {
 123   4                      //     detect_engine_pulse_cnt[0]++;
 124   4                      // }
 125   4                      engine_speed_scan_cnt++;
 126   4                      update_engine_speed_scan_data();
 127   4                  }
 128   3      
 129   3                  last_engine_speed_scan_level = 1;
 130   3              }
 131   2              else
 132   2              {
 133   3                  // å¦‚æœç°åœ¨æ£€æµ‹åˆ°ä½ç”µå¹³
 134   3                  last_engine_speed_scan_level = 0;
 135   3              }
 136   2      
 137   2      #endif // #if ENGINE_SPEED_SCAN_ENABLE
 138   2      
 139   2      #if SPEED_SCAN_ENABLE
 140   2              { // è®°å½•æ—¶é€Ÿæ‰«æçš„æ—¶é—´
 141   3                  static u16 cnt = 0;
 142   3                  cnt++;
 143   3                  if (cnt >= 20) // æ¯1msè¿›å…¥ä¸€æ¬¡
 144   3                  {
 145   4                      cnt = 0;
 146   4                      speed_scan_time_ms++; // æ¯1msåŠ ä¸€
 147   4      
 148   4                      // 600msï¼Œä¸ºäº†æ»¤æ‰1Hzçš„è„‰å†²ï¼Œè®¤ä¸º 1Hz==0km/h
 149   4                      if (speed_scan_time_ms >= SPEED_SCAN_OVER_TIME &&
 150   4                          flag_is_speed_scan_over_time == 0)
 151   4                      {
 152   5                          speed_scan_time_ms = 0;
 153   5                          flag_is_speed_scan_over_time = 1; // è¯´æ˜è¶…æ—¶ï¼Œè„‰å†²è®¡æ•°ä¸€ç›´æ²¡æœ‰åŠ ä¸€
 154   5                      }
 155   4                  }
 156   3              } // è®°å½•æ—¶é€Ÿæ‰«æçš„æ—¶é—´
 157   2      
 158   2              if (SPEED_SCAN_PIN) // æ£€æµ‹æ—¶é€Ÿçš„å¼•è„š
 159   2              {
 160   3                  if (0 == last_speed_scan_level)
 161   3                  {
 162   4      #if 0  // å®šæ—¶æ‰«æè„‰å†²ä¸ªæ•°æ¥è®¡ç®—æ—¶é€Ÿçš„æ–¹å¼
                     // å¦‚æœä¹‹å‰æ£€æµ‹åˆ°ä½ç”µå¹³ï¼Œç°åœ¨æ£€æµ‹åˆ°é«˜ç”µå¹³ï¼Œè¯´æ˜æœ‰ä¸Šå‡æ²¿ï¼Œå¯¹è„‰å†²è®¡æ•°
             -åŠ ä¸€
                              if (detect_speed_pulse_cnt[0] < 4294967295) // é˜²æ­¢è®¡æ•°æº¢å‡º
                              {
                                  detect_speed_pulse_cnt[0]++;
                              }
              #endif // å®šæ—¶æ‰«æè„‰å†²ä¸ªæ•°æ¥è®¡ç®—æ—¶é€Ÿçš„æ–¹å¼
 169   4      
 170   4                      speed_pulse_cnt++;
C51 COMPILER V9.60.7.0   TMR2                                                              08/02/2025 16:49:13 PAGE 4   

 171   4                      update_speed_scan_data();
 172   4                  }
 173   3      
 174   3                  last_speed_scan_level = 1;
 175   3              }
 176   2              else
 177   2              {
 178   3                  // å¦‚æœç°åœ¨æ£€æµ‹åˆ°ä½ç”µå¹³
 179   3                  last_speed_scan_level = 0;
 180   3              }
 181   2      #endif
 182   2          }
 183   1      
 184   1          // P20 = 0; // æµ‹è¯•ä¸­æ–­æŒç»­æ—¶é—´
 185   1          // é€€å‡ºä¸­æ–­è®¾ç½®IPï¼Œä¸å¯åˆ é™¤
 186   1          __IRQnIPnPop(TMR2_IRQn);
 187   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    353    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      3    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
